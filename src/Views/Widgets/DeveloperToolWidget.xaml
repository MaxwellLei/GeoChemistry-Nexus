<UserControl x:Class="GeoChemistryNexus.Views.Widgets.DeveloperToolWidget"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:hc="https://handyorg.github.io/handycontrol"
             xmlns:vm="clr-namespace:GeoChemistryNexus.ViewModels"
             xmlns:lg="clr-namespace:GeoChemistryNexus.Services"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="600">
    <UserControl.DataContext>
        <vm:DeveloperToolViewModel/>
    </UserControl.DataContext>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBlock Text="{Binding [developer_maintenance_tools],Source={x:Static lg:LanguageService.Instance}}" Style="{StaticResource TextBlockTitle}" Margin="0,0,0,16"/>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="16"/>
                <ColumnDefinition Width="1*"/>
            </Grid.ColumnDefinitions>

            <ScrollViewer Grid.Column="0">
                <StackPanel>
                    
                    <!-- 1. 全局设置 & 输出路径 -->
                    <GroupBox Header="基础设置" Margin="0,0,0,16">
                        <StackPanel>
                            <hc:ElementGroup Orientation="Horizontal" Layout="Stack">
                                <TextBox hc:InfoElement.Placeholder="输出目录" Text="{Binding TargetDirectory}" Width="400"/>
                                <Button Content="选择目录" Command="{Binding SelectTargetDirectoryCommand}"/>
                            </hc:ElementGroup>
                        </StackPanel>
                    </GroupBox>

                    <!-- 2. 服务器公告 & Info生成 -->
                    <GroupBox Header="1. 服务器信息生成 (Server Info)" Margin="0,0,0,16">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="10"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBox hc:InfoElement.Title="公告内容" 
                                         hc:InfoElement.TitlePlacement="Left"
                                         Text="{Binding Announcement}" 
                                         Height="80" TextWrapping="Wrap" AcceptsReturn="True"
                                         Margin="0,0,0,10"/>
                                
                                <StackPanel Orientation="Horizontal">
                                    <Button Content="生成 server_info.json" 
                                            Command="{Binding GenerateServerInfoCommand}" 
                                            Style="{StaticResource ButtonPrimary}"
                                            Margin="0,0,10,0"/>
                                    <Button Content="同步 PlotTemplateCategories.json" 
                                            Command="{Binding SyncCategoriesCommand}"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <TextBox Grid.Column="2"
                                     hc:InfoElement.Title="预览结果" 
                                     hc:InfoElement.TitlePlacement="Left"
                                     Text="{Binding ServerInfoResult}" 
                                     IsReadOnly="True" 
                                     TextWrapping="Wrap"
                                     VerticalContentAlignment="Top"
                                     Height="115"/>
                        </Grid>
                    </GroupBox>

                    <!-- 3. 模板管理 -->
                    <GroupBox Header="2. 模板管理 (Template Management)">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <RadioButton Content="更新模式 (添加新模板)" IsChecked="{Binding IsUpdateMode}" Margin="0,0,20,0"/>
                                <RadioButton Content="更改模式 (替换旧模板)"/>
                            </StackPanel>

                            <hc:Divider LineStrokeThickness="1" Margin="0,0,0,10"/>

                            <StackPanel Visibility="{Binding IsUpdateMode, Converter={StaticResource BooleanToVisibilityReConverter}}" Margin="0,0,0,10">
                                <TextBlock Text="注意：批量模式下会自动匹配 GraphMapList.json 中同名的模板进行替换。" 
                                           Foreground="Orange" TextWrapping="Wrap" Margin="0,0,0,5"/>
                            </StackPanel>

                            <!-- 文件选择 -->
                            <Button Content="选择新的模板压缩包 (.zip)..." Command="{Binding SelectZipCommand}" Margin="0,0,0,10"/>

                            <DataGrid ItemsSource="{Binding PendingChanges}" AutoGenerateColumns="False" Height="200" Margin="0,0,0,10" CanUserAddRows="False" HeadersVisibility="Column">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="源文件名" Binding="{Binding SourceFileName}" IsReadOnly="True" Width="150"/>
                                    <DataGridTextColumn Header="新模板名称" Binding="{Binding InternalGraphMapPath}" IsReadOnly="True" Width="150"/>
                                    <DataGridTemplateColumn Header="目标旧模板 (仅更改模式)" Width="200">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ComboBox ItemsSource="{Binding AvailableTemplates}" 
                                                          SelectedItem="{Binding TargetTemplateItem, UpdateSourceTrigger=PropertyChanged}"
                                                          DisplayMemberPath="GraphMapPath">
                                                    <ComboBox.Style>
                                                        <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding DataContext.IsUpdateMode, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="False">
                                                                    <Setter Property="IsEnabled" Value="True"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </ComboBox.Style>
                                                </ComboBox>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="状态" Binding="{Binding Status}" IsReadOnly="True" Width="*"/>
                                    <DataGridTemplateColumn Header="操作" Width="80">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="删除" 
                                                        Command="{Binding DataContext.RemovePendingItemCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                        CommandParameter="{Binding}"
                                                        Padding="5,0"
                                                        Background="#FFF0F0"
                                                        BorderBrush="#FFCCCC"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>

                            <Button Content="执行处理并导出" 
                                    Command="{Binding ProcessTemplateCommand}" 
                                    Style="{StaticResource ButtonPrimary}"
                                    HorizontalAlignment="Left" Width="200"/>
                        </StackPanel>
                    </GroupBox>

                </StackPanel>
            </ScrollViewer>

            <!-- 日志输出 -->
            <GroupBox Grid.Column="2" Header="操作日志">
                <TextBox Text="{Binding LogText}" 
                         IsReadOnly="True" 
                         TextWrapping="Wrap" 
                         VerticalScrollBarVisibility="Auto"
                         AcceptsReturn="True"/>
            </GroupBox>
        </Grid>
    </Grid>
</UserControl>
