<Page x:Class="GeoChemistryNexus.Views.MainPlotPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:hc="https://handyorg.github.io/handycontrol"
      xmlns:rg="clr-namespace:unvell.ReoGrid;assembly=unvell.ReoGrid"
      xmlns:local="clr-namespace:GeoChemistryNexus.Views"
      xmlns:tools="clr-namespace:GeoChemistryNexus.Helpers"
      xmlns:uc="clr-namespace:GeoChemistryNexus.Controls"
      xmlns:cvs="clr-namespace:GeoChemistryNexus.Converter"
      xmlns:layerModels="clr-namespace:GeoChemistryNexus.ViewModels"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:lg="clr-namespace:GeoChemistryNexus.Services"
      xmlns:ScottPlot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      xmlns:models="clr-namespace:GeoChemistryNexus.Models"
      xmlns:vwp="clr-namespace:WpfToolkit.Controls;assembly=VirtualizingWrapPanel"
      mc:Ignorable="d" 
      d:DesignHeight="450" d:DesignWidth="800"
      Title="MainPlotPage">

    <Page.InputBindings>
        <KeyBinding Key="Z" Modifiers="Control" Command="{Binding UndoCommand}"/>
        <KeyBinding Key="Y" Modifiers="Control" Command="{Binding RedoCommand}"/>
    </Page.InputBindings>

    <Page.Resources>
        <cvs:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <cvs:BoolToVisibilityReConverter x:Key="BoolToVisibilityReConverter"/>
        <cvs:GraphMapPathToIconConverter x:Key="GraphMapPathToIconConverter"/>
        <cvs:IndexToBooleanConverter x:Key="IndexToBooleanConverter"/>
        <cvs:StringToBitmapImageConverter x:Key="StringToBitmapImageConverter"/>

        <Style x:Key="TemplateTreeViewItemStyle" BasedOn="{StaticResource ModernStyleTreeViewItemStyle}" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
        </Style>

        <!-- New Modern-Style Styles -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#D1D1D1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarIconButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#0078D4"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarButtonIconStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#D1D1D1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Padding" Value="12,5"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="5" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="White"/>
                                <Setter Property="Foreground" Value="Black"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#000" Opacity="0.1" BlurRadius="4" ShadowDepth="1" Direction="270"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SlidingSegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Padding" Value="12,5"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" Background="Transparent" CornerRadius="5" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarDropdownStyle" TargetType="uc:ModernRibbonButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="uc:ModernRibbonButton">
                        <Grid Background="Transparent">
                            <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                                <Grid>
                                    <TextBlock FontFamily="{TemplateBinding IconFontFamily}" Text="{TemplateBinding IconCode}" 
                                               FontSize="16" Foreground="{TemplateBinding Foreground}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    <Popup x:Name="PART_Popup" AllowsTransparency="True" Placement="Bottom" 
                                           PlacementTarget="{Binding ElementName=border}" StaysOpen="False"
                                           IsOpen="{Binding IsChecked, ElementName=ToggleBtn, Mode=TwoWay}">
                                        <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Margin="0,4,0,0">
                                            <Border.Effect>
                                                <DropShadowEffect BlurRadius="10" ShadowDepth="2" Direction="270" Color="#20000000" Opacity="0.4"/>
                                            </Border.Effect>
                                            <ContentPresenter Content="{TemplateBinding MenuContent}"/>
                                        </Border>
                                    </Popup>
                                </Grid>
                            </Border>
                            <!-- Invisible Toggle Button overlay to handle clicks -->
                            <ToggleButton x:Name="ToggleBtn"
                                          Opacity="0" Background="Transparent" BorderThickness="0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid>
        <!-- æ¨¡æ¿æµè§ˆæ¨¡å¼ -->
        <Grid x:Name="TemplateGrid" Visibility="{Binding IsPlotMode, Converter={StaticResource BoolToVisibilityReConverter}}" Opacity="1" RenderTransformOrigin="0.5,0.5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="340"/>
                <ColumnDefinition Width="4"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- å·¦ä¾§æ¨¡æ¿åˆ†ç±»æ ‘ -->
            <DockPanel Grid.Column="0" Background="#F5F5F7">
                <!--æ–°å»ºæ¨¡æ¿-->
                <Menu DockPanel.Dock="Top" Background="Transparent">
                    <MenuItem Header="{Binding [File],Source={x:Static lg:LanguageService.Instance}}">
                        <!--æ–°å»ºæ¨¡æ¿-->
                        <MenuItem Header="{Binding [create_new_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding NewTemplateCommand}"
                                  Icon="ðŸ“„"/>
                        <!--æ‰“å¼€æ¨¡æ¿-->
                        <MenuItem Header="{Binding [open_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding OpenTemplateCommand}"
                                  Icon="ðŸ“‚"/>
                        <!--å¯¼å…¥è‡ªå®šä¹‰æ¨¡æ¿-->
                        <MenuItem Header="{Binding [import_custom_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding ImportCustomTemplateCommand}"
                                  Icon="ðŸ“¥"/>
                    </MenuItem>

                    <MenuItem Header="{Binding [update],Source={x:Static lg:LanguageService.Instance}}">
                        <MenuItem Header="{Binding [check_for_template_updates], Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding CheckForTemplateUpdatesCommand}" Icon="ðŸ”„"/>
                    </MenuItem>

                    <!--ç»´æŠ¤-->
                    <MenuItem Header="{Binding [maintenance], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç»´æŠ¤'}"
                              Visibility="{Binding IsDeveloperMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <MenuItem Header="{Binding [export_update_list], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='å¯¼å‡ºæ›´æ–°åˆ—è¡¨'}"
                                  Command="{Binding ExportUpdateListCommand}"/>
                    </MenuItem>
                </Menu>



                <!-- æ¨¡æ¿åˆ†ç±»æ ‘ -->
                <TreeView ItemsSource="{Binding GraphMapTemplateNode.Children}"
                          x:Name="TemplateTreeView"
                          Background="Transparent" 
                          ItemContainerStyle="{StaticResource TemplateTreeViewItemStyle}"
                          BorderThickness="0">
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <Grid Background="Transparent">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding GraphMapPath, Converter={StaticResource GraphMapPathToIconConverter}}" 
                                               FontSize="14" Margin="0,0,8,0"/>
                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                </StackPanel>
                                <Border Grid.Column="1" CornerRadius="10" Padding="6,2" Margin="8,0,0,0" VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#E9E9EF"/>
                                            <Setter Property="Visibility" Value="Visible"/>
                                            <Style.Triggers>
                                                <!-- ä»…åœ¨æœ‰å­é¡¹ï¼ˆåˆ†ç±»èŠ‚ç‚¹ï¼‰æ—¶æ˜¾ç¤ºæ•°é‡ï¼›å¶å­æ¨¡æ¿éšè— -->
                                                <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                                <!-- Selected: White badge -->
                                                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                    <Setter Property="Background" Value="White"/>
                                                </DataTrigger>

                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock Text="{Binding TemplateCount}" FontSize="12">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible"/>
                                                <Setter Property="Foreground" Value="#555"/>
                                                <Style.Triggers>
                                                    <!-- Selected: Blue Text -->
                                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                        <Setter Property="Foreground" Value="#0078D4"/>
                                                    </DataTrigger>

                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </Grid>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="SelectedItemChanged">
                            <i:InvokeCommandAction Command="{Binding SelectTreeViewItemCommand}"
                                                  CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                </TreeView>
            </DockPanel>

            <!-- åˆ†éš”æ¡ -->
            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" ShowsPreview="True">
                <GridSplitter.Template>
                    <ControlTemplate TargetType="GridSplitter">
                        <Grid Background="Transparent">
                            <Rectangle Width="1" HorizontalAlignment="Center" Fill="#E0E0E0"/>
                        </Grid>
                    </ControlTemplate>
                </GridSplitter.Template>
            </GridSplitter>

            <!-- å³ä¾§æ¨¡æ¿å¡ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <Grid Grid.Column="2" Background="#F5F5F5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- é¢åŒ…å±‘å¯¼èˆª -->
                <Border Grid.Row="0" Background="White" BorderBrush="#E0E0E0" 
                        BorderThickness="0,0,0,1" Padding="20,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="{Binding [template_library],Source={x:Static lg:LanguageService.Instance}}" FontSize="18" FontWeight="Bold" 
                                  Foreground="#333" Margin="0,0,20,0" VerticalAlignment="Center"/>
                        <ScrollViewer Grid.Column="1" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" x:Name="BreadcrumbScrollViewer" SizeChanged="BreadcrumbScrollViewer_SizeChanged">
                            <ItemsControl ItemsSource="{Binding Breadcrumbs}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="{Binding Name}" 
                                                   Command="{Binding DataContext.NavigateToBreadcrumbCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                   CommandParameter="{Binding}"
                                                   Style="{StaticResource {x:Static ToolBar.ButtonStyleKey}}"
                                                   Foreground="#0078D4" FontSize="14"/>
                                            <TextBlock Text=" > " Margin="5,0" FontSize="14" 
                                                      Foreground="#999" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>

                <!-- æ¨¡æ¿å¡ç‰‡ç½‘æ ¼ (è™šæ‹ŸåŒ–) -->
                <ListBox Grid.Row="1" ItemsSource="{Binding TemplateCardsView}" Margin="10" 
                         x:Name="TemplateCardsControl"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         VirtualizingPanel.ScrollUnit="Pixel"
                         Background="Transparent" BorderThickness="0">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <vwp:VirtualizingWrapPanel Orientation="Horizontal" StretchItems="True"/>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <ContentPresenter />
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Height="260" MinWidth="260" Tag="{Binding DataContext, ElementName=TemplateCardsControl}">
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource TemplateCardStyle}">
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsCustomTemplate}" Value="False"/>
                                                    <!-- Use Tag binding for IsDeveloperMode because Border is not part of logical tree during binding evaluation inside style sometimes? No, ElementName works on Border itself usually, but let's be safe and consistent -->
                                                    <Condition Binding="{Binding Tag.IsDeveloperMode, RelativeSource={RelativeSource Self}}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="BorderBrush" Value="DarkRed"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Border.ContextMenu>
                                    <ContextMenu>
                                        <!--å¯¼å‡ºå›¾è§£æ¨¡æ¿-->
                                        <MenuItem Header="{Binding [export_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                                  Command="{Binding PlacementTarget.Tag.ExportTemplateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}"/>
                                        <!--è½¬æ¢ä¸ºå†…ç½®æ¨¡æ¿ (å¼€å‘è€…æ¨¡å¼)-->
                                        <MenuItem Header="{Binding [convert_to_builtin_template],Source={x:Static lg:LanguageService.Instance}, TargetNullValue='è½¬æ¢ä¸ºå†…ç½®æ¨¡æ¿'}"
                                                  Command="{Binding PlacementTarget.Tag.ConvertToBuiltInCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}">
                                            <MenuItem.Style>
                                                <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsCustomTemplate}" Value="True"/>
                                                                <Condition Binding="{Binding PlacementTarget.Tag.IsDeveloperMode, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Value="True"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </MultiDataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </MenuItem.Style>
                                        </MenuItem>
                                        <MenuItem Header="{Binding [Delete],Source={x:Static lg:LanguageService.Instance}}" 
                                                  Command="{Binding PlacementTarget.Tag.DeleteTemplateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}"
                                                  Visibility="{Binding IsCustomTemplate, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseLeftButtonUp">
                                        <i:InvokeCommandAction Command="{Binding CardClickCommand}"/>
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="Loaded">
                                        <i:InvokeCommandAction Command="{Binding CheckReadinessCommand}"/>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Thumbnails -->
                                    <Grid Grid.Row="0" Margin="8,8,8,0">
                                        <Border x:Name="ThumbnailBorder" CornerRadius="6,6,0,0" Background="#F8F9FA" ClipToBounds="True">
                                            <Image Stretch="Uniform">
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Setter Property="Source" Value="{Binding ThumbnailImage}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ThumbnailImage}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="{Binding ThumbnailPath, Converter={StaticResource StringToBitmapImageConverter}}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                        </Border>

                                        <!-- Update Button -->
                                        <Button VerticalAlignment="Top" HorizontalAlignment="Left" Margin="0"
                                                Width="{Binding ActualWidth, ElementName=ThumbnailBorder}"
                                                Command="{Binding UpdateCommand}"
                                                Padding="0,8" Background="#0078D4" Foreground="White"
                                                BorderThickness="0" Cursor="Hand">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="6,6,0,0">
                                                                    <ContentPresenter HorizontalAlignment="Stretch" VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                     <Trigger Property="IsMouseOver" Value="True">
                                                                         <Setter Property="Opacity" Value="0.9"/>
                                                                     </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding State}" Value="UpdateAvailable">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                            <ScrollViewer HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" PanningMode="HorizontalOnly" IsHitTestVisible="False">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                    <TextBlock Text="&#xE118;" FontFamily="Segoe MDL2 Assets" FontSize="12" Margin="0,1,6,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding [update_available_click_to_download], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œç‚¹å‡»æ›´æ–°'}" 
                                                               FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </ScrollViewer>
                                        </Button>

                                        <Border CornerRadius="6,6,0,0" Background="#80000000">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding State}" Value="NotDownloaded">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding State}" Value="Downloading">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding State}" Value="Error">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>

                                            <Grid>
                                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <StackPanel.Style>
                                                        <Style TargetType="StackPanel">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="NotDownloaded">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding State}" Value="Error">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </StackPanel.Style>

                                                    <TextBlock Text="â¬‡" FontSize="30" Foreground="White" 
                                       HorizontalAlignment="Center" Margin="0,0,0,5"/>

                                                    <TextBlock Text="{Binding StateText}" Foreground="White" 
                                       FontSize="14" FontWeight="Bold"/>
                                                </StackPanel>

                                                <StackPanel VerticalAlignment="Center" Margin="20,0">
                                                    <StackPanel.Style>
                                                        <Style TargetType="StackPanel">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="Downloading">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </StackPanel.Style>

                                                    <TextBlock Text="{Binding [downloading_ellipsis],Source={x:Static lg:LanguageService.Instance}}" Foreground="White" Margin="0,0,0,5" HorizontalAlignment="Center"/>
                                                    <ProgressBar Value="{Binding DownloadProgress}" Maximum="100" Height="10" BorderThickness="0"/>
                                                    <TextBlock Text="{Binding DownloadProgress, StringFormat={}{0:0}%}" 
                                       Foreground="White" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </Grid>

                                    <!--æ¨¡æ¿åç§°å’Œåˆ†ç±»-->
                                    <StackPanel Grid.Row="1" Margin="12,8,12,12" HorizontalAlignment="Stretch">
                                        <TextBlock Text="{Binding Name}" 
                                                  FontWeight="Bold" FontSize="14" 
                                                  Foreground="#333" TextAlignment="Center"
                                                  TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Category}" 
                                                  FontSize="12" Foreground="#666" 
                                                  TextAlignment="Center" Margin="0,4,0,0"
                                                  TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Grid>

        <!-- Plot Mode (Modern Style Redesign) -->
        <Grid x:Name="PlotGrid" Visibility="{Binding IsPlotMode, Converter={StaticResource BoolToVisibilityConverter}}" Background="#FFFFFF">
            <Grid.RowDefinitions>
                <RowDefinition Height="52"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                <Grid Margin="10,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Back & Mode Switch -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Command="{Binding BackToTemplateModeCommand}" Style="{StaticResource ToolbarButtonStyle}" 
                                ToolTip="{Binding [return_to_template_library], Source={x:Static lg:LanguageService.Instance}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe61f;" FontSize="16" Margin="0,1,6,0"/>
                                <TextBlock Text="{Binding [return_to_template_library],Source={x:Static lg:LanguageService.Instance}}" FontWeight="SemiBold"/>
                                <TextBlock Text="*" Foreground="Red" Margin="2,-8,0,0" FontWeight="Bold" FontSize="18"
                                           Visibility="{Binding HasUnsavedChanges, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="12,0"/>

                        <Border Background="#EFEFEF" CornerRadius="6" Padding="3">
                            <Grid>
                                <Border x:Name="SwitchSlider" HorizontalAlignment="Left" VerticalAlignment="Stretch" 
                                        Background="White" CornerRadius="5" Width="0" Margin="0">
                                    <Border.Effect>
                                        <DropShadowEffect Color="#000" Opacity="0.1" BlurRadius="4" ShadowDepth="1" Direction="270"/>
                                    </Border.Effect>
                                </Border>
                                <StackPanel x:Name="SwitchContainer" Orientation="Horizontal" IsVisibleChanged="OnSwitchContainerIsVisibleChanged">
                                    <RadioButton Content="{Binding [diagram], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=0}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked" Loaded="OnSwitchRadioButtonLoaded"/>
                                    <RadioButton Content="{Binding [Data], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=1}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked"/>
                                    <RadioButton Content="{Binding [Edit], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=2}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- Right: Tools -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">

                        <!-- Common Tools -->
                        <Button Command="{Binding CenterPlotCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [reset_view], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe617;" FontSize="16"/>
                        </Button>



                        <!-- Snap Selection -->
                        <ToggleButton Style="{StaticResource ToolbarIconButtonStyle}" IsChecked="{Binding IsSnapSelectionEnabled, Mode=TwoWay}"
                                                ToolTip="{Binding [highlight_on_hover],Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe82e;" FontSize="14"/>
                        </ToggleButton>

                        <ToggleButton IsChecked="{Binding IsCrosshairVisible}" Style="{StaticResource ToolbarIconButtonStyle}"
                                       ToolTip="{Binding [coordinate_positioning], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe61e;" FontSize="16"/>
                        </ToggleButton>

                        <Button Command="{Binding CancelSelectedCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [deselect], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xeaf2;" FontSize="16"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                        <!-- Edit Mode Tools -->
                        <StackPanel Orientation="Horizontal">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="2">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <Button Command="{Binding SaveBaseMapCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [Save], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe61a;" FontSize="16" Foreground="#0078D4"/>
                            </Button>
                            <Button Command="{Binding SaveBaseMapAsCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [save_as], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe618;" FontSize="16"/>
                            </Button>
                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <ToggleButton IsChecked="{Binding IsAddingLine}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_line], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe619;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingText}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_text], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe603;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingPolygon}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_polygon], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xf2b3;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingArrow}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_arrow], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe6d5;" FontSize="16"/>
                            </ToggleButton>
                            <Button Command="{Binding AddFunctionCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_function], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe63a;" FontSize="16"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <Button Command="{Binding UndoCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [undo], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="Segoe UI Symbol" Text="&#x21A9;" FontSize="16"/>
                            </Button>
                            <Button Command="{Binding RedoCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="Redo">
                                <TextBlock FontFamily="Segoe UI Symbol" Text="&#x21AA;" FontSize="16"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <Button Command="{Binding DeleteSelectedObjectCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_object], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe6a2;" FontSize="18" Foreground="#D92C2C"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                        </StackPanel>

                        <!-- Settings & Export -->
                        <Button Command="{Binding PlotSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_title_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe62b;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding ScriptSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_script_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe614;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding LegendSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_legend_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe6ae;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding GridSettingCommand}" IsEnabled="{Binding IsGridSettingEnabled}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_grid_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe67b;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding SwitchTemplateLanguageCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [switch_diagram_language], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe6b4;" FontSize="16"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                        <!-- Copy Image to Clipboard -->
                        <Button Command="{Binding CopyToClipboardCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [copy_plot_to_clipboard], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe64d;" FontSize="16"/>
                        </Button>

                        <!-- Export / External Tools -->
                        <Button Command="{Binding ShowExportPanelCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [export_and_tools], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç€µç…Žåš­/å®¸ãƒ¥å¿'}">
                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe648;" FontSize="18"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>



                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content -->
            <Grid Grid.Row="1" x:Name="MainLayoutGrid">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition x:Name="InnerLeftCol" Width="280" MinWidth="200" MaxWidth="500"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition x:Name="PlotColumn" Width="*"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition x:Name="OuterRightCol" Width="320" MinWidth="250" MaxWidth="600"/>
                </Grid.ColumnDefinitions>

                <!-- Left Panel: Layers / Data -->
                <Border Grid.Column="0" Background="#F5F5F7" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Data Toolbar -->
                        <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="10,5">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="1">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel Orientation="Horizontal">
                                <Button Command="{Binding AddRowUpCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_row_above], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe615;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding AddRowDownCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_row_below], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe613;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding DeleteRowCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_row], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe89f;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                                <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                                <Button Command="{Binding AddColumnLeftCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_col_left], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe611;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding AddColumnRightCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_col_right], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe610;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding DeleteColumnCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_column], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe907;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                                <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                                <Button Command="{Binding ExportWorksheetCommand}" CommandParameter="{Binding ElementName=DataGrid}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [export_data], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe656;" FontSize="16" Foreground="#0078D4"/>
                                </Button>
                                <Button Command="{Binding UpdateDataCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [update_chart], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe71e;" FontSize="16" Foreground="#0078D4"/>
                                </Button>
                                <Button Command="{Binding ClearAllDataCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [clear_all_data], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe734;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <!-- Layer Tree -->
                        <TreeView Grid.Row="1" ItemsSource="{Binding LayerTree}" x:Name="LayerTreeView" Background="Transparent" BorderThickness="0">
                            <TreeView.Style>
                                <Style TargetType="TreeView">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="0">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="2">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TreeView.Style>
                            <TreeView.Resources>
                                <HierarchicalDataTemplate DataType="{x:Type layerModels:LayerItemViewModel}" ItemsSource="{Binding Children}">
                                    <StackPanel Orientation="Horizontal" Margin="2">
                                        <CheckBox IsChecked="{Binding IsVisible}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                            </TreeView.Resources>
                            <TreeView.ItemContainerStyle>
                                <Style BasedOn="{StaticResource ModernStyleTreeViewItemStyle}" TargetType="{x:Type TreeViewItem}">
                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=OneWay}"/>
                                    <EventSetter Event="UIElement.PreviewMouseLeftButtonDown" Handler="OnTreeViewItemPreviewMouseLeftButtonDown"/>
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                        </TreeView>

                        <!-- Data Grid -->
                        <rg:ReoGridControl Grid.Row="1" x:Name="DataGrid" SheetTabVisible="False" ScrollViewer.HorizontalScrollBarVisibility="Auto">
                            <rg:ReoGridControl.Resources>
                                <Style TargetType="{x:Type ScrollBar}" BasedOn="{StaticResource ScrollBarBaseStyle}"/>
                            </rg:ReoGridControl.Resources>
                            <rg:ReoGridControl.Style>
                                <Style TargetType="rg:ReoGridControl">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="1">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </rg:ReoGridControl.Style>
                        </rg:ReoGridControl>
                    </Grid>
                </Border>

                <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Stretch" Background="Transparent"/>

                <!-- Center Panel: Plot -->
                <Grid Grid.Column="2" Background="#FFFFFF" x:Name="PlotContainer" ClipToBounds="True">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ScottPlot:WpfPlot Grid.Row="0" Name="WpfPlot1" Margin="10"/>

                    <Button Grid.Row="0" Style="{StaticResource ToolbarButtonIconStyle}" Click="OnPopOutPlotClick" 
                            ToolTip="{Binding [popup_diagram_window],Source={x:Static lg:LanguageService.Instance}}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10" Panel.ZIndex="1">
                        <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe642;" FontSize="14"/>
                    </Button>

                    <Button Grid.Row="0" Command="{Binding ShowTemplateInfoCommand}" 
                            ToolTip="{Binding [use_help], Source={x:Static lg:LanguageService.Instance}}" 
                            Style="{StaticResource ToolbarButtonIconStyle}"
                            HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" Panel.ZIndex="1">
                        <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe621;" FontSize="16"/>
                    </Button>

                    <!-- Quest Reminder Overlay -->
                    <Grid Grid.Row="0" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,45,2,0"
                          Visibility="{Binding IsDataStateReminderVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                          Panel.ZIndex="99">
                        <Grid.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Direction="270" Color="#40000000" Opacity="0.2"/>
                        </Grid.Effect>

                        <!-- Arrow pointing up -->
                        <Path Data="M 3,10 L 8,0 L 16,10 Z" Fill="#FFF4CE" Stroke="#F5C346" StrokeThickness="1.5"
                              HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,0,14,0"/>

                        <!-- Box -->
                        <Border Background="#FFF4CE" BorderBrush="#F5C346" BorderThickness="1.5" CornerRadius="6" Padding="12,8" Margin="0,9,0,0">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- Icon -->
                                <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe698;" FontSize="20" Foreground="#D48806" VerticalAlignment="Center" Margin="0,0,8,0"/>

                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="{Binding [diagram_guide], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='å›¾è§£å‘å¯¼'}" FontWeight="Bold" Foreground="#333" FontSize="13"/>
                                    <TextBlock Text="{Binding [click_help_for_guide], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£'}" Foreground="#555" FontSize="12" Margin="0,2,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Mask to hide the border line between arrow and box -->
                        <Rectangle Fill="#FFF4CE" Height="3" Width="12" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,9,16,0"/>
                    </Grid>

                    <!-- Help Content Overlay  -->
                    <Border Grid.Row="0" Background="White" Margin="0"
                             Visibility="{Binding IsShowTemplateInfo, Converter={StaticResource BoolToVisibilityConverter}}" 
                             Panel.ZIndex="100">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>


                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="10,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Editor Tools -->
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <StackPanel.Style>
                                            <Style TargetType="StackPanel">
                                                <Setter Property="IsEnabled" Value="True"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsHelpDocReadOnly}" Value="True">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </StackPanel.Style>
                                        <!-- Font Size -->
                                        <hc:ComboBox x:Name="FontSizeComboBox" Width="80" Height="28" 
                                                  SelectionChanged="FontSizeComboBox_SelectionChanged" IsEditable="True"
                                                  KeyDown="FontSizeComboBox_KeyDown" LostFocus="FontSizeComboBox_LostFocus"
                                                  ToolTip="Font Size" Margin="0,0,8,0" VerticalAlignment="Center"
                                                  Padding="6,0">
                                            <ComboBoxItem Content="8"/>
                                            <ComboBoxItem Content="9"/>
                                            <ComboBoxItem Content="10"/>
                                            <ComboBoxItem Content="11"/>
                                            <ComboBoxItem Content="12"/>
                                            <ComboBoxItem Content="14"/>
                                            <ComboBoxItem Content="16"/>
                                            <ComboBoxItem Content="18"/>
                                            <ComboBoxItem Content="20"/>
                                            <ComboBoxItem Content="24"/>
                                            <ComboBoxItem Content="28"/>
                                            <ComboBoxItem Content="32"/>
                                            <ComboBoxItem Content="48"/>
                                            <ComboBoxItem Content="72"/>
                                        </hc:ComboBox>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Text Color -->
                                        <ToggleButton x:Name="ColorButton" ToolTip="Text Color" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0">
                                            <Grid>
                                                <TextBlock Text="A" FontSize="16" FontWeight="Bold" Foreground="#333" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,0,3"/>
                                                <Border Height="3" VerticalAlignment="Bottom" Margin="4,0,4,4" Background="{Binding ElementName=RichTextColorPicker, Path=SelectedBrush}" CornerRadius="1"/>
                                            </Grid>
                                        </ToggleButton>
                                        <Popup IsOpen="{Binding IsChecked, ElementName=ColorButton}" StaysOpen="False" PlacementTarget="{Binding ElementName=ColorButton}" Placement="Bottom" AllowsTransparency="True">
                                            <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Padding="5">
                                                <Border.Effect>
                                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Direction="270" Color="#20000000" Opacity="0.4"/>
                                                </Border.Effect>
                                                <uc:CustomColorPicker x:Name="RichTextColorPicker" Width="270" Height="Auto" SelectedColor="Black"/>
                                            </Border>
                                        </Popup>

                                        <!-- Text Style -->
                                        <ToggleButton x:Name="BoldButton" Command="EditingCommands.ToggleBold" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Bold" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0">
                                            <TextBlock Text="B" FontWeight="Bold" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="ItalicButton" Command="EditingCommands.ToggleItalic" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Italic" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0">
                                            <TextBlock Text="I" FontStyle="Italic" FontWeight="Bold" FontSize="16" FontFamily="Times New Roman" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="UnderlineButton" Command="EditingCommands.ToggleUnderline" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Underline" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,8,0">
                                            <TextBlock Text="U" TextDecorations="Underline" FontWeight="Bold" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Sub/Super Script -->
                                        <ToggleButton x:Name="SubscriptButton" Click="SubscriptButton_Click" ToolTip="Subscript" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0">
                                            <TextBlock Text="xâ‚‚" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="SuperscriptButton" Click="SuperscriptButton_Click" ToolTip="Superscript" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,8,0">
                                            <TextBlock Text="xÂ²" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Refresh -->
                                        <Button Command="{Binding RefreshHelpDocCommand}" ToolTip="Refresh" Style="{StaticResource ToolbarButtonIconStyle}" Margin="0,0,4,0">
                                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe74b;" FontSize="20"/>
                                        </Button>

                                        <!-- Word -->
                                        <Button Command="{Binding OpenHelpDocInWordCommand}" ToolTip="Open in Word" Style="{StaticResource ToolbarButtonIconStyle}">
                                            <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe640;" FontSize="20"/>
                                        </Button>
                                    </StackPanel>

                                    <!-- Close Button (Modern Style) -->
                                    <Button Grid.Column="2" Command="{Binding ShowTemplateInfoCommand}" 
                                             ToolTip="Close" 
                                             Width="28" Height="28" Background="Transparent" BorderThickness="0" Cursor="Hand">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <TextBlock Text="&#xe61f;" FontFamily="../Data/Icon/#iconfont" Foreground="#666" FontSize="14" 
                                                                VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#E5E5E5"/>
                                                        <Setter Property="Foreground" Value="#333"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </Grid>
                            </Border>

                            <RichTextBox Grid.Row="1" x:Name="Drichtextbox" IsReadOnly="{Binding IsHelpDocReadOnly}" 
                              BorderThickness="0" Background="Transparent" Margin="24"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto"
                              Foreground="Black"
                              SelectionChanged="Drichtextbox_SelectionChanged"/>
                        </Grid>
                    </Border>
                    <!-- Info Bar -->
                    <Border Grid.Row="1" Background="#F9F9F9" Padding="10,4" BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                        <Grid>
                            <TextBlock Text="{Binding DiagramLanguageStatus}" HorizontalAlignment="Left" Foreground="#888" FontSize="12"/>
                            <TextBlock Text="{Binding CoordinateStatus}" HorizontalAlignment="Right" Foreground="#888" FontSize="12"/>
                        </Grid>
                    </Border>
                </Grid>

                <GridSplitter Grid.Column="3" Width="4" HorizontalAlignment="Stretch" Background="Transparent"/>

                <!-- Right Panel: Inspector -->
                <Border Grid.Column="4" Background="#F5F5F7" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Property Grid -->
                        <Grid Grid.Row="0" Margin="0">
                            <Grid.Resources>
                                <ControlTemplate x:Key="EmptyStateTemplate">
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock FontFamily="../Data/Icon/#iconfont" Text="&#xe63d;" 
                                        FontSize="48" Foreground="#CCCCCC" 
                                        HorizontalAlignment="Center" Margin="0,0,0,10"/>
                                        <TextBlock Text="{Binding [select_an_object],Source={x:Static lg:LanguageService.Instance}}" FontSize="14" Foreground="#999999" 
                                        HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </ControlTemplate>
                            </Grid.Resources>

                            <ContentControl Content="{Binding PropertyGridModel}">
                                <ContentControl.Style>
                                    <Style TargetType="ContentControl">
                                        <Style.Triggers>
                                            <Trigger Property="Content" Value="{x:Null}">
                                                <Setter Property="Template" Value="{StaticResource EmptyStateTemplate}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ContentControl.Style>
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type models:EmptyPropertyModel}">
                                        <Control Template="{StaticResource EmptyStateTemplate}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type layerModels:ExportPanelViewModel}">
                                        <uc:ExportPropertyControl/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TextDefinition}">
                                        <uc:TextPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:LineDefinition}">
                                        <uc:LinePropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:ArrowDefinition}">
                                        <uc:ArrowPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:PolygonDefinition}">
                                        <uc:PolygonPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:CartesianAxisDefinition}">
                                        <uc:AxisPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TernaryAxisDefinition}">
                                        <uc:TernaryAxisPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:GridDefinition}">
                                        <uc:GridPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:LegendDefinition}">
                                        <uc:LegendPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TitleDefinition}">
                                        <uc:TitlePropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:FunctionDefinition}">
                                        <uc:FunctionPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:ScatterDefinition}">
                                        <uc:ScatterPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </Grid>

                        <uc:ScriptDefinitionControl Grid.Row="0"
                                         ScriptDefinition="{Binding CurrentScript}"
                                         Visibility="{Binding ScriptsPropertyGrid, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>
