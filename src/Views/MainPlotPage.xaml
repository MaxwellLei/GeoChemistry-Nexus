<Page x:Class="GeoChemistryNexus.Views.MainPlotPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:hc="https://handyorg.github.io/handycontrol"
      xmlns:rg="clr-namespace:unvell.ReoGrid;assembly=unvell.ReoGrid"
      xmlns:local="clr-namespace:GeoChemistryNexus.Views"
      xmlns:tools="clr-namespace:GeoChemistryNexus.Helpers"
      xmlns:uc="clr-namespace:GeoChemistryNexus.Controls"
      xmlns:cvs="clr-namespace:GeoChemistryNexus.Converter"
      xmlns:layerModels="clr-namespace:GeoChemistryNexus.ViewModels"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:lg="clr-namespace:GeoChemistryNexus.Services"
      xmlns:ScottPlot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
      xmlns:sys="clr-namespace:System;assembly=mscorlib"
      xmlns:s="clr-namespace:System;assembly=mscorlib"
      xmlns:models="clr-namespace:GeoChemistryNexus.Models"
      xmlns:vwp="clr-namespace:WpfToolkit.Controls;assembly=VirtualizingWrapPanel"
      mc:Ignorable="d" 
      d:DesignHeight="450" d:DesignWidth="800"
      Title="MainPlotPage"
      Focusable="True">

    <Page.InputBindings>
        <KeyBinding Key="Z" Modifiers="Control" Command="{Binding UndoCommand}"/>
        <KeyBinding Key="Y" Modifiers="Control" Command="{Binding RedoCommand}"/>
        <KeyBinding Key="Delete" Command="{Binding DeleteSelectedObjectCommand}"/>
        <KeyBinding Key="D0" Modifiers="Control" Command="{Binding CenterPlotCommand}"/>
        <KeyBinding Key="NumPad0" Modifiers="Control" Command="{Binding CenterPlotCommand}"/>
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveBaseMapCommand}"/>
        <!-- æ·»åŠ ç»˜å›¾å¯¹è±¡å¿«æ·é”® -->
        <KeyBinding Key="D1" Modifiers="Control" Command="{Binding AddLineCommand}"/>
        <KeyBinding Key="NumPad1" Modifiers="Control" Command="{Binding AddLineCommand}"/>
        <KeyBinding Key="D2" Modifiers="Control" Command="{Binding AddTextCommand}"/>
        <KeyBinding Key="NumPad2" Modifiers="Control" Command="{Binding AddTextCommand}"/>
        <KeyBinding Key="D3" Modifiers="Control" Command="{Binding AddPolygonCommand}"/>
        <KeyBinding Key="NumPad3" Modifiers="Control" Command="{Binding AddPolygonCommand}"/>
        <KeyBinding Key="D4" Modifiers="Control" Command="{Binding AddArrowCommand}"/>
        <KeyBinding Key="NumPad4" Modifiers="Control" Command="{Binding AddArrowCommand}"/>
        <KeyBinding Key="D5" Modifiers="Control" Command="{Binding AddFunctionCommand}"/>
        <KeyBinding Key="NumPad5" Modifiers="Control" Command="{Binding AddFunctionCommand}"/>
    </Page.InputBindings>

    <Page.Resources>
        <!-- åŠ è½½iconfontå­—ä½“ -->
        <FontFamily x:Key="IconFont">pack://application:,,,/Data/Icon/#iconfont</FontFamily>
        
        <cvs:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <cvs:BoolToVisibilityReConverter x:Key="BoolToVisibilityReConverter"/>
        <cvs:GraphMapPathToIconConverter x:Key="GraphMapPathToIconConverter"/>
        <cvs:IndexToBooleanConverter x:Key="IndexToBooleanConverter"/>
        <cvs:StringToBitmapImageConverter x:Key="StringToBitmapImageConverter"/>

        <Style x:Key="TemplateTreeViewItemStyle" BasedOn="{StaticResource ModernStyleTreeViewItemStyle}" TargetType="TreeViewItem">
            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
            <EventSetter Event="RequestBringIntoView" Handler="TreeViewItem_RequestBringIntoView"/>
        </Style>

        <!-- New Modern-Style Styles -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="Margin" Value="4,0"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#D1D1D1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarIconButtonStyle" TargetType="ToggleButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#0078D4"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarButtonIconStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#D1D1D1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Padding" Value="12,5"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="5" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="border" Property="Background" Value="White"/>
                                <Setter Property="Foreground" Value="Black"/>
                                <Setter TargetName="border" Property="Effect">
                                    <Setter.Value>
                                        <DropShadowEffect Color="#000" Opacity="0.1" BlurRadius="4" ShadowDepth="1" Direction="270"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SlidingSegmentedRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Padding" Value="12,5"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border" Background="Transparent" CornerRadius="5" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ToolbarDropdownStyle" TargetType="uc:ModernRibbonButton">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="Margin" Value="2,0"/>
            <Setter Property="Foreground" Value="#555"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="uc:ModernRibbonButton">
                        <Grid Background="Transparent">
                            <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="6" ToolTip="{TemplateBinding ToolTip}">
                                <Grid>
                                    <TextBlock FontFamily="{TemplateBinding IconFontFamily}" Text="{TemplateBinding IconCode}" 
                                               FontSize="16" Foreground="{TemplateBinding Foreground}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    <Popup x:Name="PART_Popup" AllowsTransparency="True" Placement="Bottom" 
                                           PlacementTarget="{Binding ElementName=border}" StaysOpen="False"
                                           IsOpen="{Binding IsChecked, ElementName=ToggleBtn, Mode=TwoWay}">
                                        <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Margin="0,4,0,0">
                                            <Border.Effect>
                                                <DropShadowEffect BlurRadius="10" ShadowDepth="2" Direction="270" Color="#20000000" Opacity="0.4"/>
                                            </Border.Effect>
                                            <ContentPresenter Content="{TemplateBinding MenuContent}"/>
                                        </Border>
                                    </Popup>
                                </Grid>
                            </Border>
                            <!-- Invisible Toggle Button overlay to handle clicks -->
                            <ToggleButton x:Name="ToggleBtn"
                                          Opacity="0" Background="Transparent" BorderThickness="0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#E5E5E5"/>
                                <Setter Property="Foreground" Value="#000"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Page.Resources>

    <Grid>
        <!-- æ¨¡æ¿æµè§ˆæ¨¡å¼ -->
        <Grid x:Name="TemplateGrid" Visibility="{Binding IsPlotMode, Converter={StaticResource BoolToVisibilityReConverter}}" Opacity="1" RenderTransformOrigin="0.5,0.5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="340"/>
                <ColumnDefinition Width="4"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- å·¦ä¾§æ¨¡æ¿åˆ†ç±»æ ‘ -->
            <DockPanel Grid.Column="0" Background="#F5F5F7">
                <!--æ–°å»ºæ¨¡æ¿-->
                <Menu DockPanel.Dock="Top" Background="Transparent">
                    <MenuItem Header="{Binding [File],Source={x:Static lg:LanguageService.Instance}}">
                        <!--æ–°å»ºæ¨¡æ¿-->
                        <MenuItem Header="{Binding [create_new_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding NewTemplateCommand}"
                                  Icon="ðŸ“„"/>
                        <!--æ‰“å¼€æ¨¡æ¿-->
                        <MenuItem Header="{Binding [open_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding OpenTemplateCommand}"
                                  Icon="ðŸ“‚"/>
                        <!--å¯¼å…¥è‡ªå®šä¹‰æ¨¡æ¿-->
                        <MenuItem Header="{Binding [import_custom_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding ImportCustomTemplateCommand}"
                                  Icon="ðŸ“¥"/>
                    </MenuItem>

                    <MenuItem Header="{Binding [update],Source={x:Static lg:LanguageService.Instance}}">
                        <MenuItem Header="{Binding [check_for_template_updates], Source={x:Static lg:LanguageService.Instance}}" 
                                  Command="{Binding CheckForTemplateUpdatesCommand}" Icon="ðŸ”„"/>
                    </MenuItem>

                    <!--ç»´æŠ¤-->
                    <MenuItem Header="{Binding [maintenance], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç»´æŠ¤'}"
                              Visibility="{Binding IsDeveloperMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <MenuItem Header="{Binding [export_update_list], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='å¯¼å‡ºæ›´æ–°åˆ—è¡¨'}"
                                  Command="{Binding ExportUpdateListCommand}"/>
                    </MenuItem>
                </Menu>

                <!-- æ–°çš„åˆ—è¡¨å¼ä¾§è¾¹æ èœå• -->
                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <StackPanel Margin="0">
                        <!-- åˆ†ç»„ä¸€ï¼šèµ„æºåº“ -->
                        <TextBlock Text="{Binding [library_section],Source={x:Static lg:LanguageService.Instance}, FallbackValue='èµ„æºåº“'}" 
                                   FontSize="11" FontWeight="SemiBold" 
                                   Foreground="#666666"
                                   Margin="16,16,16,8"/>
                        
                        <!-- å®˜æ–¹å›¾è§£ -->
                        <Button Background="Transparent" BorderThickness="0" 
                                Padding="12,10" Cursor="Hand"
                                HorizontalContentAlignment="Stretch"
                                Command="{Binding ToggleCategoryExpansionCommand}"
                                CommandParameter="Official">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="BorderElement"
                                                        Background="{TemplateBinding Background}" 
                                                        Padding="{TemplateBinding Padding}"
                                                        CornerRadius="6"
                                                        Margin="8,0">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="BorderElement" Property="Background" Value="#EAEAEA"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsOfficialExpanded}" Value="True">
                                            <Setter Property="Background" Value="#E5E5E5"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="&#xe8e1;" FontFamily="{StaticResource IconFont}" FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding [official_templates],Source={x:Static lg:LanguageService.Instance}}" 
                                           FontSize="14" 
                                           Foreground="#333333"
                                           VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" FontFamily="Segoe MDL2 Assets" 
                                           FontSize="10" Foreground="#808080" 
                                           VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="&#xE76C;"/>
                                            <Setter Property="RenderTransform">
                                                <Setter.Value>
                                                    <RotateTransform Angle="0"/>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsOfficialExpanded}" Value="True">
                                                    <DataTrigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                 To="90" Duration="0:0:0.15"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </DataTrigger.EnterActions>
                                                    <DataTrigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                 To="0" Duration="0:0:0.15"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </DataTrigger.ExitActions>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </Button>
                        
                        <!-- å®˜æ–¹å›¾è§£å­æ ‘ -->
                        <Border x:Name="OfficialTreeBorder"
                                ClipToBounds="True">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="MaxHeight" Value="0"/>
                                    <Setter Property="Opacity" Value="0"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsOfficialExpanded}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                         To="800" Duration="0:0:0.3">
                                                            <DoubleAnimation.EasingFunction>
                                                                <CubicEase EasingMode="EaseOut"/>
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                         To="1.0" Duration="0:0:0.25"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                         To="0" Duration="0:0:0.25">
                                                            <DoubleAnimation.EasingFunction>
                                                                <CubicEase EasingMode="EaseIn"/>
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                         To="0" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TreeView ItemsSource="{Binding OfficialTemplatesNode.Children}"
                                      Background="Transparent" 
                                      ItemContainerStyle="{StaticResource TemplateTreeViewItemStyle}"
                                      BorderThickness="0"
                                      Margin="20,4,8,8"
                                      PreviewMouseWheel="TreeView_PreviewMouseWheel">
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <Grid Background="Transparent">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding GraphMapPath, Converter={StaticResource GraphMapPathToIconConverter}}" 
                                                           FontSize="14" Margin="0,0,8,0"/>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                            <Border Grid.Column="1" CornerRadius="10" Padding="6,2" Margin="8,0,0,0" VerticalAlignment="Center">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="#E9E9EF"/>
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                                <Setter Property="Background" Value="White"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding TemplateCount}" FontSize="12">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Foreground" Value="#555"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                                    <Setter Property="Foreground" Value="#0078D4"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="SelectedItemChanged">
                                        <i:InvokeCommandAction Command="{Binding SelectTreeViewItemCommand}"
                                                              CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </TreeView>
                        </Border>
                        
                        <!-- åˆ†éš”çº¿ -->
                        <Rectangle Height="1" Fill="#E0E0E0" Margin="16,12"/>
                        
                        <!-- åˆ†ç»„äºŒï¼šæˆ‘çš„ç©ºé—´ -->
                        <TextBlock Text="{Binding [workspace_section],Source={x:Static lg:LanguageService.Instance}, FallbackValue='æˆ‘çš„ç©ºé—´'}" 
                                   FontSize="11" FontWeight="SemiBold" 
                                   Foreground="#666666"
                                   Margin="16,8,16,8"/>
                        
                        <!-- ä¸ªäººå›¾è§£ -->
                        <Button Background="Transparent" BorderThickness="0" 
                                Padding="12,10" Cursor="Hand"
                                HorizontalContentAlignment="Stretch"
                                Command="{Binding ToggleCategoryExpansionCommand}"
                                CommandParameter="Personal">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="BorderElement"
                                                        Background="{TemplateBinding Background}" 
                                                        Padding="{TemplateBinding Padding}"
                                                        CornerRadius="6"
                                                        Margin="8,0">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="BorderElement" Property="Background" Value="#EAEAEA"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPersonalExpanded}" Value="True">
                                            <Setter Property="Background" Value="#E5E5E5"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="&#xe623;" FontFamily="{StaticResource IconFont}" FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding [personal_templates],Source={x:Static lg:LanguageService.Instance}}" 
                                           FontSize="14" 
                                           Foreground="#333333"
                                           VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" FontFamily="Segoe MDL2 Assets" 
                                           FontSize="10" Foreground="#808080" 
                                           VerticalAlignment="Center">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="&#xE76C;"/>
                                            <Setter Property="RenderTransform">
                                                <Setter.Value>
                                                    <RotateTransform Angle="0"/>
                                                </Setter.Value>
                                            </Setter>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsPersonalExpanded}" Value="True">
                                                    <DataTrigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                 To="90" Duration="0:0:0.15"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </DataTrigger.EnterActions>
                                                    <DataTrigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation Storyboard.TargetProperty="RenderTransform.Angle" 
                                                                                 To="0" Duration="0:0:0.15"/>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </DataTrigger.ExitActions>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </Button>
                        
                        <!-- ä¸ªäººå›¾è§£å­æ ‘ -->
                        <Border x:Name="PersonalTreeBorder"
                                ClipToBounds="True">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="MaxHeight" Value="0"/>
                                    <Setter Property="Opacity" Value="0"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPersonalExpanded}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                         To="800" Duration="0:0:0.3">
                                                            <DoubleAnimation.EasingFunction>
                                                                <CubicEase EasingMode="EaseOut"/>
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                         To="1.0" Duration="0:0:0.25"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="MaxHeight" 
                                                                         To="0" Duration="0:0:0.25">
                                                            <DoubleAnimation.EasingFunction>
                                                                <CubicEase EasingMode="EaseIn"/>
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                         To="0" Duration="0:0:0.2"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.ExitActions>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TreeView ItemsSource="{Binding PersonalTemplatesNode.Children}"
                                      Background="Transparent" 
                                      ItemContainerStyle="{StaticResource TemplateTreeViewItemStyle}"
                                      BorderThickness="0"
                                      Margin="20,4,8,8"
                                      PreviewMouseWheel="TreeView_PreviewMouseWheel">
                                <TreeView.ItemTemplate>
                                    <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                        <Grid Background="Transparent">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding GraphMapPath, Converter={StaticResource GraphMapPathToIconConverter}}" 
                                                           FontSize="14" Margin="0,0,8,0"/>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                            <Border Grid.Column="1" CornerRadius="10" Padding="6,2" Margin="8,0,0,0" VerticalAlignment="Center">
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Setter Property="Background" Value="#E9E9EF"/>
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Children.Count}" Value="0">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                                <Setter Property="Background" Value="White"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <TextBlock Text="{Binding TemplateCount}" FontSize="12">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Foreground" Value="#555"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=TreeViewItem}}" Value="True">
                                                                    <Setter Property="Foreground" Value="#0078D4"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </Border>
                                        </Grid>
                                    </HierarchicalDataTemplate>
                                </TreeView.ItemTemplate>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="SelectedItemChanged">
                                        <i:InvokeCommandAction Command="{Binding SelectTreeViewItemCommand}"
                                                              CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=TreeView}}"/>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </TreeView>
                        </Border>
                        
                        <!-- æ”¶è— -->
                        <Button Background="Transparent" BorderThickness="0" 
                                Padding="12,10" Cursor="Hand"
                                HorizontalContentAlignment="Stretch"
                                Command="{Binding ToggleCategoryExpansionCommand}"
                                CommandParameter="Favorite">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="BorderElement"
                                                        Background="{TemplateBinding Background}" 
                                                        Padding="{TemplateBinding Padding}"
                                                        CornerRadius="6"
                                                        Margin="8,0">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="BorderElement" Property="Background" Value="#EAEAEA"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFavoriteExpanded}" Value="True">
                                            <Setter Property="Background" Value="#E5E5E5"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="&#xe649;" FontFamily="{StaticResource IconFont}" FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding [favorite_templates],Source={x:Static lg:LanguageService.Instance}}" 
                                           FontSize="14" 
                                           Foreground="#333333"
                                           VerticalAlignment="Center"/>
                            </Grid>
                        </Button>
                        
                        <!-- æœ€è¿‘ä½¿ç”¨ -->
                        <Button Background="Transparent" BorderThickness="0" 
                                Padding="12,10" Cursor="Hand"
                                HorizontalContentAlignment="Stretch"
                                Command="{Binding ToggleCategoryExpansionCommand}"
                                CommandParameter="Recents">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="BorderElement"
                                                        Background="{TemplateBinding Background}" 
                                                        Padding="{TemplateBinding Padding}"
                                                        CornerRadius="6"
                                                        Margin="8,0">
                                                    <ContentPresenter/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="BorderElement" Property="Background" Value="#EAEAEA"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRecentsExpanded}" Value="True">
                                            <Setter Property="Background" Value="#E5E5E5"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="&#xe80d;" FontFamily="{StaticResource IconFont}" FontSize="16" Margin="0,0,10,0" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding [recents_templates],Source={x:Static lg:LanguageService.Instance}, FallbackValue='æœ€è¿‘ä½¿ç”¨'}" 
                                           FontSize="14" 
                                           Foreground="#333333"
                                           VerticalAlignment="Center"/>
                            </Grid>
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </DockPanel>

            <!-- åˆ†éš”æ¡ -->
            <GridSplitter Grid.Column="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" ShowsPreview="True">
                <GridSplitter.Template>
                    <ControlTemplate TargetType="GridSplitter">
                        <Grid Background="Transparent">
                            <Rectangle Width="1" HorizontalAlignment="Center" Fill="#E0E0E0"/>
                        </Grid>
                    </ControlTemplate>
                </GridSplitter.Template>
            </GridSplitter>

            <!-- å³ä¾§æ¨¡æ¿å¡ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <Grid Grid.Column="2" Background="#F5F5F5">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- é¡¶éƒ¨æ ï¼ˆé¢åŒ…å±‘å¯¼èˆª + æ ‡é¢˜å’Œæœç´¢å·¥å…·ï¼‰ -->
                <Border Grid.Row="0" Background="White" BorderBrush="#E0E0E0" 
                        BorderThickness="0,0,0,1" Padding="20,12">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- ç¬¬ä¸€è¡Œï¼šé¢åŒ…å±‘å¯¼èˆª -->
                        <ScrollViewer Grid.Row="0" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" 
                                      x:Name="BreadcrumbScrollViewer" SizeChanged="BreadcrumbScrollViewer_SizeChanged"
                                      Margin="0,0,0,10">
                            <ItemsControl ItemsSource="{Binding Breadcrumbs}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock>
                                                <Hyperlink Command="{Binding DataContext.NavigateToBreadcrumbCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                           CommandParameter="{Binding}"
                                                           TextDecorations="None"
                                                           Foreground="#666">
                                                    <Run Text="{Binding Name}" FontSize="12"/>
                                                </Hyperlink>
                                            </TextBlock>
                                            <TextBlock Text=" / " Margin="4,0" FontSize="12" 
                                                      Foreground="#999" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- ç¬¬äºŒè¡Œï¼šæ ‡é¢˜å’Œæœç´¢ç­›é€‰å·¥å…·æ  -->
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- å·¦ä¾§ï¼šæ¨¡æ¿åº“æ ‡é¢˜ -->
                            <TextBlock Grid.Column="0" 
                                       FontSize="20" FontWeight="SemiBold" 
                                       Foreground="#333" 
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <!-- é»˜è®¤æ˜¾ç¤º CurrentCategoryNameï¼Œå¦‚æžœä¸ºç©ºåˆ™æ˜¾ç¤ºâ€œæ¨¡æ¿åº“â€ -->
                                        <Setter Property="Text" Value="{Binding CurrentCategoryName}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding CurrentCategoryName}" Value="">
                                                <Setter Property="Text" Value="{Binding [template_library],Source={x:Static lg:LanguageService.Instance}}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            
                            <!-- å³ä¾§ï¼šæ‰¹é‡ä¸‹è½½æŒ‰é’®ã€æœç´¢æ¡†å’Œç­›é€‰æŒ‰é’® -->
                            <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- æ‰¹é‡ä¸‹è½½æŒ‰é’® -->
                                <Button Height="32" Padding="12,0" Margin="0,0,8,0"
                                        Background="#0078D4" BorderBrush="#0078D4" BorderThickness="1"
                                        Foreground="White"
                                        Command="{Binding BatchDownloadNewTemplatesCommand}"
                                        ToolTip="{Binding [batch_download_new_templates_tooltip], Source={x:Static lg:LanguageService.Instance}, FallbackValue='æ‰¹é‡ä¸‹è½½æ–°æ¨¡æ¿'}"
                                        Cursor="Hand"
                                        Visibility="{Binding IsBatchDownloadButtonVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                BorderBrush="{TemplateBinding BorderBrush}" 
                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                CornerRadius="4"
                                                                Padding="{TemplateBinding Padding}">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="&#xE896;" FontFamily="Segoe MDL2 Assets" 
                                                                           FontSize="14" Foreground="{TemplateBinding Foreground}" 
                                                                           VerticalAlignment="Center" Margin="0,0,4,0"/>
                                                                <TextBlock Text="{Binding [batch_download_new_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='æ‰¹é‡ä¸‹è½½'}" 
                                                                           FontSize="13" Foreground="{TemplateBinding Foreground}" 
                                                                           VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#005A9E"/>
                                                                <Setter Property="BorderBrush" Value="#005A9E"/>
                                                            </Trigger>
                                                            <Trigger Property="IsPressed" Value="True">
                                                                <Setter Property="Background" Value="#004578"/>
                                                                <Setter Property="BorderBrush" Value="#004578"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                
                                <!-- æœç´¢æ¡† -->
                                <TextBox Width="240" Height="32" Padding="8,6" 
                                         Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                         VerticalAlignment="Center" FontSize="13"
                                         BorderBrush="#D0D0D0" BorderThickness="1">
                                    <TextBox.Style>
                                        <Style TargetType="TextBox">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="TextBox">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                BorderBrush="{TemplateBinding BorderBrush}" 
                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                CornerRadius="4">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>
                                                                <!-- æœç´¢å›¾æ ‡ -->
                                                                <TextBlock Grid.Column="0" Text="&#xE721;" FontFamily="Segoe MDL2 Assets" 
                                                                           FontSize="14" Foreground="#999" Margin="8,0,4,0" 
                                                                           VerticalAlignment="Center"/>
                                                                <!-- å ä½ç¬¦æ–‡æœ¬ -->
                                                                <TextBlock Grid.Column="1" 
                                                                           Text="{Binding [search_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='æœç´¢æ¨¡æ¿...'}" 
                                                                           FontSize="13" Foreground="#999" 
                                                                           Margin="10,0,8,0" VerticalAlignment="Center"
                                                                           IsHitTestVisible="False">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding Text, RelativeSource={RelativeSource TemplatedParent}}" Value="">
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                                <!-- è¾“å…¥æ¡† -->
                                                                <ScrollViewer Grid.Column="1" x:Name="PART_ContentHost" 
                                                                              VerticalAlignment="Center" 
                                                                              Margin="0,0,8,0"/>
                                                            </Grid>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsFocused" Value="True">
                                                                <Setter Property="BorderBrush" Value="#0078D4"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </TextBox.Style>
                                </TextBox>
                                
                                <!-- ç­›é€‰æŒ‰é’®ï¼ˆæ¼æ–—å›¾æ ‡ï¼‰ -->
                                <Button Width="32" Height="32" Margin="8,0,0,0"
                                        Background="White" BorderBrush="#D0D0D0" BorderThickness="1"
                                        ToolTip="{Binding [filter_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='ç­›é€‰æ¨¡æ¿'}"
                                        Click="FilterButton_Click"
                                        Cursor="Hand">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" 
                                                                BorderBrush="{TemplateBinding BorderBrush}" 
                                                                BorderThickness="{TemplateBinding BorderThickness}"
                                                                CornerRadius="4">
                                                            <TextBlock Text="&#xE71C;" FontFamily="Segoe MDL2 Assets" 
                                                                       FontSize="14" Foreground="#666" 
                                                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#F5F5F5"/>
                                                            </Trigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                    <!-- ç­›é€‰èœå•å¼¹å‡º -->
                                    <Button.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="{Binding [all_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='å…¨éƒ¨æ¨¡æ¿'}" 
                                                      Command="{Binding SetFilterTypeCommand}" CommandParameter="0"
                                                      IsCheckable="True" IsChecked="{Binding FilterType, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=0, Mode=OneWay}"/>
                                            <MenuItem Header="{Binding [custom_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='è‡ªå®šä¹‰æ¨¡æ¿'}" 
                                                      Command="{Binding SetFilterTypeCommand}" CommandParameter="1"
                                                      IsCheckable="True" IsChecked="{Binding FilterType, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=1, Mode=OneWay}"/>
                                            <MenuItem Header="{Binding [builtin_templates], Source={x:Static lg:LanguageService.Instance}, FallbackValue='å†…ç½®æ¨¡æ¿'}" 
                                                      Command="{Binding SetFilterTypeCommand}" CommandParameter="2"
                                                      IsCheckable="True" IsChecked="{Binding FilterType, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=2, Mode=OneWay}"/>
                                            <Separator/>
                                            <MenuItem Header="{Binding [clear_search], Source={x:Static lg:LanguageService.Instance}, FallbackValue='æ¸…é™¤ç­›é€‰'}" 
                                                      Command="{Binding ClearSearchCommand}"/>
                                        </ContextMenu>
                                    </Button.ContextMenu>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <!-- æ¨¡æ¿å¡ç‰‡ç½‘æ ¼ (è™šæ‹ŸåŒ–) -->
                <ListBox Grid.Row="1" ItemsSource="{Binding TemplateCardsView}" Margin="10" 
                         x:Name="TemplateCardsControl"
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         VirtualizingPanel.ScrollUnit="Pixel"
                         Background="Transparent" BorderThickness="0">
                    <ListBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <vwp:VirtualizingWrapPanel Orientation="Horizontal" StretchItems="True"/>
                        </ItemsPanelTemplate>
                    </ListBox.ItemsPanel>
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <ContentPresenter />
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Height="260" MinWidth="260" Tag="{Binding DataContext, ElementName=TemplateCardsControl}">
                                <Border.Style>
                                    <Style TargetType="Border" BasedOn="{StaticResource TemplateCardStyle}">
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsCustomTemplate}" Value="False"/>
                                                    <!-- Use Tag binding for IsDeveloperMode because Border is not part of logical tree during binding evaluation inside style sometimes? No, ElementName works on Border itself usually, but let's be safe and consistent -->
                                                    <Condition Binding="{Binding Tag.IsDeveloperMode, RelativeSource={RelativeSource Self}}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="BorderBrush" Value="DarkRed"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Border.ContextMenu>
                                    <ContextMenu>
                                        <!--æ”¶è—/å–æ¶ˆæ”¶è—-->
                                        <MenuItem Command="{Binding PlacementTarget.Tag.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}">
                                            <MenuItem.Style>
                                                <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                                    <Setter Property="Header" Value="{Binding [favorite],Source={x:Static lg:LanguageService.Instance}}"/>
                                                    <Style.Triggers>
                                                        <!-- å¦‚æžœå·²ç»æ”¶è—ï¼Œæ˜¾ç¤º"å–æ¶ˆæ”¶è—" -->
                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                            <Setter Property="Header" Value="{Binding [unfavorite],Source={x:Static lg:LanguageService.Instance}}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </MenuItem.Style>
                                        </MenuItem>
                                        <Separator/>
                                        <!--ç¼–è¾‘å›¾è§£æ¨¡æ¿-->
                                        <MenuItem Header="{Binding [edit_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                                  Command="{Binding PlacementTarget.Tag.EditTemplateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}">
                                            <MenuItem.Style>
                                                <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <!-- ä¸ªäººå›¾è§£æ˜¾ç¤ºç¼–è¾‘é€‰é¡¹ -->
                                                        <DataTrigger Binding="{Binding IsCustomTemplate}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <!-- å¼€å‘è€…æ¨¡å¼ä¸‹éžä¸ªäººå›¾è§£æ‰æ˜¾ç¤ºç¼–è¾‘é€‰é¡¹ -->
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsCustomTemplate}" Value="False"/>
                                                                <Condition Binding="{Binding PlacementTarget.Tag.IsDeveloperMode, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Value="True"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </MultiDataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </MenuItem.Style>
                                        </MenuItem>
                                        <!--å¯¼å‡ºå›¾è§£æ¨¡æ¿-->
                                        <MenuItem Header="{Binding [export_diagram_template],Source={x:Static lg:LanguageService.Instance}}" 
                                                  Command="{Binding PlacementTarget.Tag.ExportTemplateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}"/>
                                        <!--è½¬æ¢ä¸ºå†…ç½®æ¨¡æ¿ (å¼€å‘è€…æ¨¡å¼)-->
                                        <MenuItem Header="{Binding [convert_to_builtin_template],Source={x:Static lg:LanguageService.Instance}, TargetNullValue='è½¬æ¢ä¸ºå†…ç½®æ¨¡æ¿'}"
                                                  Command="{Binding PlacementTarget.Tag.ConvertToBuiltInCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}">
                                            <MenuItem.Style>
                                                <Style TargetType="MenuItem" BasedOn="{StaticResource {x:Type MenuItem}}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <MultiDataTrigger>
                                                            <MultiDataTrigger.Conditions>
                                                                <Condition Binding="{Binding IsCustomTemplate}" Value="True"/>
                                                                <Condition Binding="{Binding PlacementTarget.Tag.IsDeveloperMode, RelativeSource={RelativeSource AncestorType=ContextMenu}}" Value="True"/>
                                                            </MultiDataTrigger.Conditions>
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </MultiDataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </MenuItem.Style>
                                        </MenuItem>
                                        <MenuItem Header="{Binding [Delete],Source={x:Static lg:LanguageService.Instance}}" 
                                                  Command="{Binding PlacementTarget.Tag.DeleteTemplateCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                  CommandParameter="{Binding}"
                                                  Visibility="{Binding IsCustomTemplate, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                    </ContextMenu>
                                </Border.ContextMenu>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger EventName="MouseLeftButtonUp">
                                        <i:InvokeCommandAction Command="{Binding CardClickCommand}"/>
                                    </i:EventTrigger>
                                    <i:EventTrigger EventName="Loaded">
                                        <i:InvokeCommandAction Command="{Binding CheckReadinessCommand}"/>
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Thumbnails -->
                                    <Grid Grid.Row="0" Margin="8,8,8,0">
                                        <Border x:Name="ThumbnailBorder" CornerRadius="6,6,0,0" Background="#F8F9FA" ClipToBounds="True">
                                            <Image Stretch="Uniform">
                                                <Image.Style>
                                                    <Style TargetType="Image">
                                                        <Setter Property="Source" Value="{Binding ThumbnailImage}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding ThumbnailImage}" Value="{x:Null}">
                                                                <Setter Property="Source" Value="{Binding ThumbnailPath, Converter={StaticResource StringToBitmapImageConverter}}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Image.Style>
                                            </Image>
                                        </Border>

                                        <!-- æ”¶è—å›¾æ ‡æŒ‰é’® -->
                                        <Button VerticalAlignment="Top" HorizontalAlignment="Right" 
                                                Width="28" Height="28" Margin="4"
                                                Command="{Binding ToggleFavoriteCommand}"
                                                Background="Transparent" BorderThickness="0" 
                                                Cursor="Hand"
                                                Opacity="0"
                                                Panel.ZIndex="999">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border x:Name="FavoriteBorder" 
                                                                        Background="{TemplateBinding Background}" 
                                                                        CornerRadius="14"
                                                                        Width="28" Height="28">
                                                                    <TextBlock x:Name="FavoriteIcon" 
                                                                               Text="&#xe649;" 
                                                                               FontFamily="{StaticResource IconFont}" 
                                                                               FontSize="16" 
                                                                               Foreground="#999" 
                                                                               HorizontalAlignment="Center" 
                                                                               VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                    <!-- é¼ æ ‡æ‚¬åœæ•ˆæžœ -->
                                                                    <Trigger Property="IsMouseOver" Value="True">
                                                                        <Setter TargetName="FavoriteBorder" Property="Background" Value="#F0F0F0"/>
                                                                    </Trigger>
                                                                    <!-- å·²æ”¶è—çŠ¶æ€ - é«˜äº®æ˜¾ç¤º -->
                                                                    <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                        <Setter TargetName="FavoriteIcon" Property="Foreground" Value="#FFD700"/>
                                                                    </DataTrigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <!-- å¡ç‰‡é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºæ”¶è—æŒ‰é’® -->
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=Border}}" Value="True">
                                                            <DataTrigger.EnterActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                         To="1.0" Duration="0:0:0.2"/>
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </DataTrigger.EnterActions>
                                                            <DataTrigger.ExitActions>
                                                                <BeginStoryboard>
                                                                    <Storyboard>
                                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                         To="0" Duration="0:0:0.2"/>
                                                                    </Storyboard>
                                                                </BeginStoryboard>
                                                            </DataTrigger.ExitActions>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                        <Button VerticalAlignment="Top" HorizontalAlignment="Left" Margin="0"
                                                Width="{Binding ActualWidth, ElementName=ThumbnailBorder}"
                                                Command="{Binding UpdateCommand}"
                                                Padding="0,8" Background="#0078D4" Foreground="White"
                                                BorderThickness="0" Cursor="Hand">
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}" CornerRadius="6,6,0,0">
                                                                    <ContentPresenter HorizontalAlignment="Stretch" VerticalAlignment="Center"/>
                                                                </Border>
                                                                <ControlTemplate.Triggers>
                                                                     <Trigger Property="IsMouseOver" Value="True">
                                                                         <Setter Property="Opacity" Value="0.9"/>
                                                                     </Trigger>
                                                                </ControlTemplate.Triggers>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding State}" Value="UpdateAvailable">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                            <ScrollViewer HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled" PanningMode="HorizontalOnly" IsHitTestVisible="False">
                                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                    <TextBlock Text="&#xE118;" FontFamily="Segoe MDL2 Assets" FontSize="12" Margin="0,1,6,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding [update_available_click_to_download], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œç‚¹å‡»æ›´æ–°'}" 
                                                               FontWeight="SemiBold" FontSize="11" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </ScrollViewer>
                                        </Button>

                                        <Border CornerRadius="6,6,0,0" Background="#80000000">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding State}" Value="NotDownloaded">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding State}" Value="Downloading">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding State}" Value="Error">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>

                                            <Grid>
                                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                                    <StackPanel.Style>
                                                        <Style TargetType="StackPanel">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="NotDownloaded">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding State}" Value="Error">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </StackPanel.Style>

                                                    <TextBlock Text="â¬‡" FontSize="30" Foreground="White" 
                                       HorizontalAlignment="Center" Margin="0,0,0,5"/>

                                                    <TextBlock Text="{Binding StateText}" Foreground="White" 
                                       FontSize="14" FontWeight="Bold"/>
                                                </StackPanel>

                                                <StackPanel VerticalAlignment="Center" Margin="20,0">
                                                    <StackPanel.Style>
                                                        <Style TargetType="StackPanel">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding State}" Value="Downloading">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </StackPanel.Style>

                                                    <TextBlock Text="{Binding [downloading_ellipsis],Source={x:Static lg:LanguageService.Instance}}" Foreground="White" Margin="0,0,0,5" HorizontalAlignment="Center"/>
                                                    <ProgressBar Value="{Binding DownloadProgress}" Maximum="100" Height="10" BorderThickness="0"/>
                                                    <TextBlock Text="{Binding DownloadProgress, StringFormat={}{0:0}%}" 
                                       Foreground="White" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </Grid>

                                    <!--æ¨¡æ¿åç§°å’Œåˆ†ç±»-->
                                    <StackPanel Grid.Row="1" Margin="12,8,12,12" HorizontalAlignment="Stretch">
                                        <TextBlock Text="{Binding Name}" 
                                                  FontWeight="Bold" FontSize="14" 
                                                  Foreground="#333" TextAlignment="Center"
                                                  TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding Category}" 
                                                  FontSize="12" Foreground="#666" 
                                                  TextAlignment="Center" Margin="0,4,0,0"
                                                  TextWrapping="Wrap"/>
                                    </StackPanel>

                                    <!-- Ctrl é”®é®ç½©å±‚ -->
                                    <Border Grid.Row="0" Grid.RowSpan="2" Background="#66000000" CornerRadius="6" 
                                            Panel.ZIndex="1000">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsCtrlOverlayVisible}" Value="True">
                                                        <DataTrigger.EnterActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility">
                                                                        <DiscreteObjectKeyFrame KeyTime="0" Value="{x:Static Visibility.Visible}"/>
                                                                    </ObjectAnimationUsingKeyFrames>
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     From="0" To="1" Duration="0:0:0.15"/>
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.EnterActions>
                                                        <DataTrigger.ExitActions>
                                                            <BeginStoryboard>
                                                                <Storyboard>
                                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" 
                                                                                     To="0" Duration="0:0:0.15"/>
                                                                    <ObjectAnimationUsingKeyFrames Storyboard.TargetProperty="Visibility">
                                                                        <DiscreteObjectKeyFrame KeyTime="0:0:0.15" Value="{x:Static Visibility.Collapsed}"/>
                                                                    </ObjectAnimationUsingKeyFrames>
                                                                </Storyboard>
                                                            </BeginStoryboard>
                                                        </DataTrigger.ExitActions>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- å·¦ä¾§ï¼šåˆ é™¤åŒºåŸŸ -->
                                            <Button Grid.Column="0" Background="Transparent" BorderThickness="0" 
                                                    Command="{Binding QuickDeleteCommand}" Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="DeleteArea" Background="#B0E53935" 
                                                                            CornerRadius="6,0,0,6">
                                                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                            <TextBlock Text="&#xE107;" FontFamily="Segoe MDL2 Assets" 
                                                                                       FontSize="32" Foreground="White" 
                                                                                       HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                                                            <TextBlock Text="åˆ é™¤" FontSize="14" FontWeight="Bold" 
                                                                                       Foreground="White" HorizontalAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="DeleteArea" Property="Background" Value="#E0E53935"/>
                                                                        </Trigger>
                                                                        <!-- éžè‡ªå®šä¹‰æ¨¡æ¿ä¸èƒ½åˆ é™¤ -->
                                                                        <DataTrigger Binding="{Binding IsCustomTemplate}" Value="False">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- å³ä¾§ï¼šæ”¶è—åŒºåŸŸ -->
                                            <Button Grid.Column="1" Background="Transparent" BorderThickness="0" 
                                                    Command="{Binding QuickFavoriteCommand}" Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="FavoriteArea" Background="#B0FFA726" 
                                                                            CornerRadius="0,6,6,0">
                                                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                            <TextBlock x:Name="FavoriteIcon" 
                                                                                       Text="&#xe649;" 
                                                                                       FontFamily="{StaticResource IconFont}" 
                                                                                       FontSize="32" Foreground="White" 
                                                                                       HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                                                            <TextBlock x:Name="FavoriteText" 
                                                                                       Text="æ”¶è—" FontSize="14" FontWeight="Bold" 
                                                                                       Foreground="White" HorizontalAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="FavoriteArea" Property="Background" Value="#E0FFA726"/>
                                                                        </Trigger>
                                                                        <!-- å·²æ”¶è—çŠ¶æ€ -->
                                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                            <Setter TargetName="FavoriteText" Property="Text" Value="å–æ¶ˆæ”¶è—"/>
                                                                            <Setter TargetName="FavoriteArea" Property="Background" Value="#B0FFD54F"/>
                                                                        </DataTrigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                    </Style>
                                                </Button.Style>
                                            </Button>

                                            <!-- éžè‡ªå®šä¹‰æ¨¡æ¿æ—¶ï¼Œæ”¶è—åŒºåŸŸå æ»¡æ•´ä¸ªå®½åº¦ -->
                                            <Button Grid.Column="0" Grid.ColumnSpan="2" 
                                                    Background="Transparent" BorderThickness="0" 
                                                    Command="{Binding QuickFavoriteCommand}" Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border x:Name="FullFavoriteArea" Background="#B0FFA726" 
                                                                            CornerRadius="6">
                                                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                                            <TextBlock x:Name="FullFavoriteIcon" 
                                                                                       Text="&#xe649;" 
                                                                                       FontFamily="{StaticResource IconFont}" 
                                                                                       FontSize="32" Foreground="White" 
                                                                                       HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                                                            <TextBlock x:Name="FullFavoriteText" 
                                                                                       Text="æ”¶è—" FontSize="14" FontWeight="Bold" 
                                                                                       Foreground="White" HorizontalAlignment="Center"/>
                                                                        </StackPanel>
                                                                    </Border>
                                                                    <ControlTemplate.Triggers>
                                                                        <Trigger Property="IsMouseOver" Value="True">
                                                                            <Setter TargetName="FullFavoriteArea" Property="Background" Value="#E0FFA726"/>
                                                                        </Trigger>
                                                                        <!-- å·²æ”¶è—çŠ¶æ€ -->
                                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                            <Setter TargetName="FullFavoriteText" Property="Text" Value="å–æ¶ˆæ”¶è—"/>
                                                                            <Setter TargetName="FullFavoriteArea" Property="Background" Value="#B0FFD54F"/>
                                                                        </DataTrigger>
                                                                    </ControlTemplate.Triggers>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <!-- åªæœ‰éžè‡ªå®šä¹‰æ¨¡æ¿æ‰æ˜¾ç¤ºå…¨å±æ”¶è—æŒ‰é’® -->
                                                            <DataTrigger Binding="{Binding IsCustomTemplate}" Value="False">
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
                
                <!-- æ‰¹é‡ä¸‹è½½é®ç½©å±‚ -->
                <Border Background="#80000000" 
                        Visibility="{Binding IsBatchDownloadOverlayVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                        Grid.RowSpan="2">
                    <Border Background="White" CornerRadius="12" 
                            Width="450" Height="280" 
                            VerticalAlignment="Center" HorizontalAlignment="Center"
                            Padding="40,30">
                        <Border.Effect>
                            <DropShadowEffect BlurRadius="20" ShadowDepth="0" Opacity="0.3"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- æ ‡é¢˜ -->
                            <TextBlock Grid.Row="0" Text="{Binding [batch_downloading], Source={x:Static lg:LanguageService.Instance}, FallbackValue='æ‰¹é‡ä¸‹è½½ä¸­'}" 
                                       FontSize="20" FontWeight="SemiBold" 
                                       Foreground="#333" 
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,25"/>
                            
                            <!-- åŠ è½½åŠ¨ç”» -->
                            <Grid Grid.Row="1" Width="60" Height="60" Margin="0,0,0,20" HorizontalAlignment="Center">
                                <Ellipse Width="60" Height="60" 
                                         Stroke="#0078D4" StrokeThickness="4" 
                                         Opacity="0.2"/>
                                <Ellipse Width="60" Height="60" 
                                         Stroke="#0078D4" StrokeThickness="4" 
                                         StrokeDashArray="8,4">
                                    <Ellipse.RenderTransform>
                                        <RotateTransform x:Name="LoadingRotation" CenterX="30" CenterY="30" Angle="0"/>
                                    </Ellipse.RenderTransform>
                                    <Ellipse.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetName="LoadingRotation"
                                                                   Storyboard.TargetProperty="Angle"
                                                                   From="0" To="360" Duration="0:0:1.5"/>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Ellipse.Triggers>
                                </Ellipse>
                            </Grid>
                            
                            <!-- è¿›åº¦æ–‡æœ¬ -->
                            <TextBlock Grid.Row="2" Text="{Binding BatchDownloadProgressText}" 
                                       FontSize="14" Foreground="#666" 
                                       TextAlignment="Center" TextWrapping="Wrap"
                                       VerticalAlignment="Top"
                                       MaxWidth="370"
                                       Margin="0,0,0,20"/>
                            
                            <!-- å–æ¶ˆæŒ‰é’® -->
                            <Button Grid.Row="3" 
                                    Content="{Binding [Cancel], Source={x:Static lg:LanguageService.Instance}, FallbackValue='å–æ¶ˆ'}" 
                                    Command="{Binding CancelBatchDownloadCommand}"
                                    Width="120" Height="38"
                                    Background="#F0F0F0" 
                                    BorderBrush="#D0D0D0" 
                                    BorderThickness="1"
                                    Cursor="Hand"
                                    HorizontalAlignment="Center">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            BorderBrush="{TemplateBinding BorderBrush}" 
                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                            CornerRadius="6">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#E0E0E0"/>
                                                        </Trigger>
                                                        <Trigger Property="IsPressed" Value="True">
                                                            <Setter Property="Background" Value="#D0D0D0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Border>
                </Border>
            </Grid>
        </Grid>

        <!-- Plot Mode (Modern Style Redesign) -->
        <Grid x:Name="PlotGrid" Visibility="{Binding IsPlotMode, Converter={StaticResource BoolToVisibilityConverter}}" Background="#FFFFFF">
            <Grid.RowDefinitions>
                <RowDefinition Height="52"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
                <Grid Margin="10,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Back & Mode Switch -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Command="{Binding BackToTemplateModeCommand}" Style="{StaticResource ToolbarButtonStyle}" 
                                ToolTip="{Binding [return_to_template_library], Source={x:Static lg:LanguageService.Instance}}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe61f;" FontSize="16" Margin="0,1,6,0"/>
                                <TextBlock Text="{Binding [return_to_template_library],Source={x:Static lg:LanguageService.Instance}}" FontWeight="SemiBold"/>
                                <TextBlock Text="*" Foreground="Red" Margin="2,-8,0,0" FontWeight="Bold" FontSize="18"
                                           Visibility="{Binding HasUnsavedChanges, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="12,0"/>

                        <Border Background="#EFEFEF" CornerRadius="6" Padding="3">
                            <Grid>
                                <Border x:Name="SwitchSlider" HorizontalAlignment="Left" VerticalAlignment="Stretch" 
                                        Background="White" CornerRadius="5" Width="0" Margin="0">
                                    <Border.Effect>
                                        <DropShadowEffect Color="#000" Opacity="0.1" BlurRadius="4" ShadowDepth="1" Direction="270"/>
                                    </Border.Effect>
                                </Border>
                                <StackPanel x:Name="SwitchContainer" Orientation="Horizontal" IsVisibleChanged="OnSwitchContainerIsVisibleChanged">
                                    <RadioButton Content="{Binding [diagram], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=0}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked" Loaded="OnSwitchRadioButtonLoaded"/>
                                    <RadioButton Content="{Binding [Data], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=1}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked"/>
                                    <RadioButton Content="{Binding [Edit], Source={x:Static lg:LanguageService.Instance}}" 
                                                 IsChecked="{Binding RibbonTabIndex, Converter={StaticResource IndexToBooleanConverter}, ConverterParameter=2}"
                                                 Style="{StaticResource SlidingSegmentedRadioButtonStyle}"
                                                 Checked="OnSwitchRadioButtonChecked"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </StackPanel>

                    <!-- Right: Tools -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">

                        <!-- Common Tools -->
                        <Button Command="{Binding CenterPlotCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [reset_view], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe617;" FontSize="16"/>
                        </Button>



                        <!-- Snap Selection -->
                        <ToggleButton Style="{StaticResource ToolbarIconButtonStyle}" IsChecked="{Binding IsSnapSelectionEnabled, Mode=TwoWay}"
                                                ToolTip="{Binding [highlight_on_hover],Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe82e;" FontSize="14"/>
                        </ToggleButton>

                        <ToggleButton IsChecked="{Binding IsCrosshairVisible}" Style="{StaticResource ToolbarIconButtonStyle}"
                                       ToolTip="{Binding [coordinate_positioning], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe61e;" FontSize="16"/>
                        </ToggleButton>

                        <Button Command="{Binding CancelSelectedCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [deselect], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xeaf2;" FontSize="16"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                        <!-- Edit Mode Tools -->
                        <StackPanel Orientation="Horizontal">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="2">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <Button Command="{Binding SaveBaseMapCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [Save], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe61a;" FontSize="16" Foreground="#0078D4"/>
                            </Button>
                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <ToggleButton IsChecked="{Binding IsAddingLine}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_line], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe619;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingText}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_text], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe603;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingPolygon}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_polygon], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xf2b3;" FontSize="16"/>
                            </ToggleButton>
                            <ToggleButton IsChecked="{Binding IsAddingArrow}" Style="{StaticResource ToolbarIconButtonStyle}" ToolTip="{Binding [add_arrow], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe6d5;" FontSize="16"/>
                            </ToggleButton>
                            <Button Command="{Binding AddFunctionCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_function], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe63a;" FontSize="16"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <Button Command="{Binding UndoCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [undo], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="Segoe UI Symbol" Text="&#x21A9;" FontSize="16"/>
                            </Button>
                            <Button Command="{Binding RedoCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="Redo">
                                <TextBlock FontFamily="Segoe UI Symbol" Text="&#x21AA;" FontSize="16"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                            <Button Command="{Binding DeleteSelectedObjectCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_object], Source={x:Static lg:LanguageService.Instance}}">
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe6a2;" FontSize="18" Foreground="#D92C2C"/>
                            </Button>

                            <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                        </StackPanel>

                        <!-- Settings & Export -->
                        <Button Command="{Binding PlotSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_title_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe62b;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding ScriptSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_script_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe614;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding LegendSettingCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_legend_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe6ae;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding GridSettingCommand}" IsEnabled="{Binding IsGridSettingEnabled}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [diagram_grid_properties], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe67b;" FontSize="16"/>
                        </Button>
                        <Button Command="{Binding SwitchTemplateLanguageCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [switch_diagram_language], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe6b4;" FontSize="16"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>

                        <!-- Copy Image to Clipboard -->
                        <Button Command="{Binding CopyToClipboardCommand}" Style="{StaticResource ToolbarButtonIconStyle}" 
                                ToolTip="{Binding [copy_plot_to_clipboard], Source={x:Static lg:LanguageService.Instance}}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe64d;" FontSize="16"/>
                        </Button>

                        <!-- Export / External Tools -->
                        <Button Command="{Binding ShowExportPanelCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [export_and_tools], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç€µç…Žåš­/å®¸ãƒ¥å¿'}">
                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe648;" FontSize="18"/>
                        </Button>

                        <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>



                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content -->
            <Grid Grid.Row="1" x:Name="MainLayoutGrid">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition x:Name="InnerLeftCol" Width="280" MinWidth="200" MaxWidth="500"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition x:Name="PlotColumn" Width="*"/>
                    <ColumnDefinition Width="4"/>
                    <ColumnDefinition x:Name="OuterRightCol" Width="320" MinWidth="250" MaxWidth="600"/>
                </Grid.ColumnDefinitions>

                <!-- Left Panel: Layers / Data -->
                <Border Grid.Column="0" Background="#F5F5F7" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Data Toolbar -->
                        <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="10,5">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="1">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel Orientation="Horizontal">
                                <Button Command="{Binding AddRowUpCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_row_above], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe615;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding AddRowDownCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_row_below], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe613;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding DeleteRowCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_row], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe89f;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                                <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                                <Button Command="{Binding AddColumnLeftCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_col_left], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe611;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding AddColumnRightCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [add_col_right], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe610;" FontSize="16"/>
                                </Button>
                                <Button Command="{Binding DeleteColumnCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [delete_column], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe907;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                                <Rectangle Width="1" Height="24" Fill="#D0D0D0" Margin="8,0"/>
                                <Button Command="{Binding ExportWorksheetCommand}" CommandParameter="{Binding ElementName=DataGrid}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [export_data], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe656;" FontSize="16" Foreground="#0078D4"/>
                                </Button>
                                <Button Command="{Binding UpdateDataCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [update_chart], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe71e;" FontSize="16" Foreground="#0078D4"/>
                                </Button>
                                <Button Command="{Binding ClearAllDataCommand}" Style="{StaticResource ToolbarButtonIconStyle}" ToolTip="{Binding [clear_all_data], Source={x:Static lg:LanguageService.Instance}}">
                                    <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe734;" FontSize="16" Foreground="#D92C2C"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <!-- Layer Tree -->
                        <TreeView Grid.Row="1" ItemsSource="{Binding LayerTree}" x:Name="LayerTreeView" Background="Transparent" BorderThickness="0">
                            <TreeView.Style>
                                <Style TargetType="TreeView">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="0">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="2">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TreeView.Style>
                            <TreeView.Resources>
                                <HierarchicalDataTemplate DataType="{x:Type layerModels:LayerItemViewModel}" ItemsSource="{Binding Children}">
                                    <StackPanel Orientation="Horizontal" Margin="2">
                                        <CheckBox IsChecked="{Binding IsVisible}" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                            </TreeView.Resources>
                            <TreeView.ItemContainerStyle>
                                <Style BasedOn="{StaticResource ModernStyleTreeViewItemStyle}" TargetType="{x:Type TreeViewItem}">
                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=OneWay}"/>
                                    <EventSetter Event="UIElement.PreviewMouseLeftButtonDown" Handler="OnTreeViewItemPreviewMouseLeftButtonDown"/>
                                    <EventSetter Event="RequestBringIntoView" Handler="TreeViewItem_RequestBringIntoView"/>
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                </Style>
                            </TreeView.ItemContainerStyle>
                        </TreeView>

                        <!-- Data Grid -->
                        <rg:ReoGridControl Grid.Row="1" x:Name="DataGrid" SheetTabVisible="False" ScrollViewer.HorizontalScrollBarVisibility="Auto" SizeChanged="DataGrid_SizeChanged">
                            <rg:ReoGridControl.Resources>
                                <Style TargetType="{x:Type ScrollBar}" BasedOn="{StaticResource ScrollBarBaseStyle}"/>
                            </rg:ReoGridControl.Resources>
                            <rg:ReoGridControl.Style>
                                <Style TargetType="rg:ReoGridControl">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding RibbonTabIndex}" Value="1">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </rg:ReoGridControl.Style>
                        </rg:ReoGridControl>

                        <!-- è®¡ç®—è¿‡ç¨‹éªŒè¯åŒºåŸŸ -->
                        <Border Grid.Row="2" Background="#FAFAFA" BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- ä»…åœ¨æ•°æ®çŠ¶æ€(RibbonTabIndex=1)ä¸”è®¡ç®—éªŒè¯å¯è§æ—¶æ˜¾ç¤º -->
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding RibbonTabIndex}" Value="1"/>
                                                <Condition Binding="{Binding IsCalculationVerificationVisible}" Value="True"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- æ”¶ç¼©çŠ¶æ€ï¼šæ˜¾ç¤ºè®¡ç®—ç»“æžœæ‘˜è¦ -->
                                <Border Grid.Row="0" Padding="10,0" Background="#FAFAFA">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- ç»“æžœæ‘˜è¦ -->
                                        <TextBlock Grid.Column="0" Text="{Binding CalculationResultSummary}" 
                                                   FontSize="12" Foreground="#333" VerticalAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>

                                        <!-- å±•å¼€/æ”¶ç¼©æŒ‰é’® -->
                                        <Button Grid.Column="1" Command="{Binding ToggleCalculationDetailCommand}" 
                                                Width="24" Height="24" Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                ToolTip="{Binding [toggle_details_expand_collapse],Source={x:Static lg:LanguageService.Instance}}">
                                            <Button.Template>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                                        <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" 
                                                                   Foreground="#666" FontSize="14" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Text" Value="&#xe624;"/><!-- å±•å¼€å›¾æ ‡ -->
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsCalculationDetailExpanded}" Value="True">
                                                                            <Setter Property="Text" Value="&#xe8fc;"/><!-- æ”¶èµ·å›¾æ ‡ -->
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#F0F0F0"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Button.Template>
                                        </Button>
                                    </Grid>
                                </Border>

                                <!-- å±•å¼€çŠ¶æ€ï¼šæ˜¾ç¤ºè¯¦ç»†è®¡ç®—è¿‡ç¨‹ -->
                                <Border Grid.Row="1" Padding="10,0,10,10" Background="#FAFAFA"
                                        Visibility="{Binding IsCalculationDetailExpanded, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <ScrollViewer MaxHeight="{Binding DataGridMaxVerificationHeight}" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding CalculationLogs}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" FontSize="11" Foreground="#555" 
                                                               FontFamily="Consolas" Margin="0,2" TextWrapping="Wrap"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>

                <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Stretch" Background="Transparent"/>

                <!-- Center Panel: Plot -->
                <Grid Grid.Column="2" Background="#FFFFFF" x:Name="PlotContainer" ClipToBounds="True">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ScottPlot:WpfPlot Grid.Row="0" Name="WpfPlot1" Margin="10"/>

                    <Button Grid.Row="0" Style="{StaticResource ToolbarButtonIconStyle}" Click="OnPopOutPlotClick" 
                            ToolTip="{Binding [popup_diagram_window],Source={x:Static lg:LanguageService.Instance}}" HorizontalAlignment="Left" VerticalAlignment="Top" Margin="10" Panel.ZIndex="1">
                        <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe642;" FontSize="14"/>
                    </Button>

                    <Button Grid.Row="0" Command="{Binding ShowTemplateInfoCommand}" 
                            ToolTip="{Binding [use_help], Source={x:Static lg:LanguageService.Instance}}" 
                            Style="{StaticResource ToolbarButtonIconStyle}"
                            HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10" Panel.ZIndex="1">
                        <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe621;" FontSize="16"/>
                    </Button>

                    <!-- Quest Reminder Overlay -->
                    <Grid Grid.Row="0" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,45,2,0"
                          Visibility="{Binding IsDataStateReminderVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                          Panel.ZIndex="99">
                        <Grid.Effect>
                            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Direction="270" Color="#40000000" Opacity="0.2"/>
                        </Grid.Effect>

                        <!-- Arrow pointing up -->
                        <Path Data="M 3,10 L 8,0 L 16,10 Z" Fill="#FFF4CE" Stroke="#F5C346" StrokeThickness="1.5"
                              HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,0,14,0"/>

                        <!-- Box -->
                        <Border Background="#FFF4CE" BorderBrush="#F5C346" BorderThickness="1.5" CornerRadius="6" Padding="12,8" Margin="0,9,0,0">
                            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                <!-- Icon -->
                                <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe698;" FontSize="20" Foreground="#D48806" VerticalAlignment="Center" Margin="0,0,8,0"/>

                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="{Binding [diagram_guide], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='å›¾è§£å‘å¯¼'}" FontWeight="Bold" Foreground="#333" FontSize="13"/>
                                    <TextBlock Text="{Binding [click_help_for_guide], Source={x:Static lg:LanguageService.Instance}, TargetNullValue='ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£'}" Foreground="#555" FontSize="12" Margin="0,2,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>

                        <!-- Mask to hide the border line between arrow and box -->
                        <Rectangle Fill="#FFF4CE" Height="3" Width="12" HorizontalAlignment="Right" VerticalAlignment="Top" Margin="0,9,16,0"/>
                    </Grid>

                    <!-- Help Content Overlay  -->
                    <Border Grid.Row="0" Background="White" Margin="0"
                             Visibility="{Binding IsShowTemplateInfo, Converter={StaticResource BoolToVisibilityConverter}}" 
                             Panel.ZIndex="100">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>


                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="#F9F9F9" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="10,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Editor Tools -->
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                        <StackPanel.Style>
                                            <Style TargetType="StackPanel">
                                                <Setter Property="IsEnabled" Value="True"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsHelpDocReadOnly}" Value="True">
                                                        <Setter Property="IsEnabled" Value="False"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </StackPanel.Style>
                                        <!-- Font Size -->
                                        <hc:ComboBox x:Name="FontSizeComboBox" Width="80" Height="28" 
                                                  SelectionChanged="FontSizeComboBox_SelectionChanged" IsEditable="True"
                                                  KeyDown="FontSizeComboBox_KeyDown" LostFocus="FontSizeComboBox_LostFocus"
                                                  ToolTip="Font Size" Margin="0,0,8,0" VerticalAlignment="Center"
                                                  Padding="6,0" Focusable="False">
                                            <ComboBoxItem Content="8"/>
                                            <ComboBoxItem Content="9"/>
                                            <ComboBoxItem Content="10"/>
                                            <ComboBoxItem Content="11"/>
                                            <ComboBoxItem Content="12"/>
                                            <ComboBoxItem Content="14"/>
                                            <ComboBoxItem Content="16"/>
                                            <ComboBoxItem Content="18"/>
                                            <ComboBoxItem Content="20"/>
                                            <ComboBoxItem Content="24"/>
                                            <ComboBoxItem Content="28"/>
                                            <ComboBoxItem Content="32"/>
                                            <ComboBoxItem Content="48"/>
                                            <ComboBoxItem Content="72"/>
                                        </hc:ComboBox>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Text Color -->
                                        <ToggleButton x:Name="ColorButton" ToolTip="Text Color" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0" Focusable="False">
                                            <Grid>
                                                <TextBlock Text="A" FontSize="16" FontWeight="Bold" Foreground="#333" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,0,3"/>
                                                <Border Height="3" VerticalAlignment="Bottom" Margin="4,0,4,4" Background="{Binding ElementName=RichTextColorPicker, Path=SelectedBrush}" CornerRadius="1"/>
                                            </Grid>
                                        </ToggleButton>
                                        <Popup IsOpen="{Binding IsChecked, ElementName=ColorButton}" StaysOpen="False" PlacementTarget="{Binding ElementName=ColorButton}" Placement="Bottom" AllowsTransparency="True">
                                            <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="1" CornerRadius="4" Padding="5">
                                                <Border.Effect>
                                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Direction="270" Color="#20000000" Opacity="0.4"/>
                                                </Border.Effect>
                                                <uc:CustomColorPicker x:Name="RichTextColorPicker" Width="270" Height="Auto" SelectedColor="Black"/>
                                            </Border>
                                        </Popup>

                                        <!-- Text Style -->
                                        <ToggleButton x:Name="BoldButton" Command="EditingCommands.ToggleBold" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Bold" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0" Focusable="False">
                                            <TextBlock Text="B" FontWeight="Bold" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="ItalicButton" Command="EditingCommands.ToggleItalic" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Italic" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0" Focusable="False">
                                            <TextBlock Text="I" FontStyle="Italic" FontWeight="Bold" FontSize="16" FontFamily="Times New Roman" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="UnderlineButton" Command="EditingCommands.ToggleUnderline" CommandTarget="{Binding ElementName=Drichtextbox}" ToolTip="Underline" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,8,0" Focusable="False">
                                            <TextBlock Text="U" TextDecorations="Underline" FontWeight="Bold" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Sub/Super Script -->
                                        <ToggleButton x:Name="SubscriptButton" Click="SubscriptButton_Click" ToolTip="Subscript" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,4,0" Focusable="False">
                                            <TextBlock Text="xâ‚‚" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="SuperscriptButton" Click="SuperscriptButton_Click" ToolTip="Superscript" Style="{StaticResource ToolbarIconButtonStyle}" Margin="0,0,8,0" Focusable="False">
                                            <TextBlock Text="xÂ²" FontSize="16" Foreground="#333"/>
                                        </ToggleButton>

                                        <Rectangle Width="1" Height="20" Fill="#D0D0D0" Margin="0,0,8,0"/>

                                        <!-- Word -->
                                        <Button Command="{Binding OpenHelpDocInWordCommand}" ToolTip="Open in Word" Style="{StaticResource ToolbarButtonIconStyle}" Focusable="False">
                                            <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe640;" FontSize="20"/>
                                        </Button>
                                    </StackPanel>

                                    <!-- Close Button (Modern Style) -->
                                    <Button Grid.Column="2" Command="{Binding ShowTemplateInfoCommand}" 
                                             ToolTip="Close" 
                                             Width="28" Height="28" Background="Transparent" BorderThickness="0" Cursor="Hand">
                                        <Button.Template>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" CornerRadius="6">
                                                    <TextBlock Text="&#xe61f;" FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Foreground="#666" FontSize="14" 
                                                                VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter Property="Background" Value="#E5E5E5"/>
                                                        <Setter Property="Foreground" Value="#333"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Button.Template>
                                    </Button>
                                </Grid>
                            </Border>

                            <RichTextBox Grid.Row="1" x:Name="Drichtextbox" IsReadOnly="{Binding IsHelpDocReadOnly}" 
                              BorderThickness="0" Background="Transparent" Margin="24"
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Auto"
                              Foreground="Black"
                              SelectionChanged="Drichtextbox_SelectionChanged"/>
                        </Grid>
                    </Border>
                    <!-- Info Bar -->
                    <Border Grid.Row="1" Background="#F9F9F9" Padding="10,4" BorderBrush="#E0E0E0" BorderThickness="0,1,0,0">
                        <Grid>
                            <TextBlock Text="{Binding DiagramLanguageStatus}" HorizontalAlignment="Left" Foreground="#888" FontSize="12"/>
                            <TextBlock Text="{Binding CoordinateStatus}" HorizontalAlignment="Right" Foreground="#888" FontSize="12"/>
                        </Grid>
                    </Border>
                </Grid>

                <GridSplitter Grid.Column="3" Width="4" HorizontalAlignment="Stretch" Background="Transparent"/>

                <!-- Right Panel: Inspector -->
                <Border Grid.Column="4" Background="#F5F5F7" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Property Grid -->
                        <Grid Grid.Row="0" Margin="0">
                            <Grid.Resources>
                                <ControlTemplate x:Key="EmptyStateTemplate">
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock FontFamily="pack://application:,,,/GeoChemistryNexus;component/Data/Icon/#iconfont" Text="&#xe63d;" 
                                        FontSize="48" Foreground="#CCCCCC" 
                                        HorizontalAlignment="Center" Margin="0,0,0,10"/>
                                        <TextBlock Text="{Binding [select_an_object],Source={x:Static lg:LanguageService.Instance}}" FontSize="14" Foreground="#999999" 
                                        HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </ControlTemplate>
                            </Grid.Resources>

                            <ContentControl Content="{Binding PropertyGridModel}">
                                <ContentControl.Style>
                                    <Style TargetType="ContentControl">
                                        <Style.Triggers>
                                            <Trigger Property="Content" Value="{x:Null}">
                                                <Setter Property="Template" Value="{StaticResource EmptyStateTemplate}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ContentControl.Style>
                                <ContentControl.Resources>
                                    <DataTemplate DataType="{x:Type models:EmptyPropertyModel}">
                                        <Control Template="{StaticResource EmptyStateTemplate}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type layerModels:ExportPanelViewModel}">
                                        <uc:ExportPropertyControl/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TextDefinition}">
                                        <uc:TextPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:LineDefinition}">
                                        <uc:LinePropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:ArrowDefinition}">
                                        <uc:ArrowPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:PolygonDefinition}">
                                        <uc:PolygonPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:CartesianAxisDefinition}">
                                        <uc:AxisPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TernaryAxisDefinition}">
                                        <uc:TernaryAxisPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:GridDefinition}">
                                        <uc:GridPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:LegendDefinition}">
                                        <uc:LegendPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:TitleDefinition}">
                                        <uc:TitlePropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:FunctionDefinition}">
                                        <uc:FunctionPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                    <DataTemplate DataType="{x:Type models:ScatterDefinition}">
                                        <uc:ScatterPropertyControl SelectedObject="{Binding}"/>
                                    </DataTemplate>
                                </ContentControl.Resources>
                            </ContentControl>
                        </Grid>

                        <uc:ScriptDefinitionControl Grid.Row="0"
                                         ScriptDefinition="{Binding CurrentScript}"
                                         Visibility="{Binding ScriptsPropertyGrid, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>
